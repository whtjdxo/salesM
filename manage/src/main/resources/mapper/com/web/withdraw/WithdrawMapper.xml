<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.web.manage.withdraw.mapper.WithdrawMapper">

	<select id="getQueryTotalCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
  
        <select id="getWDSummary" parameterType="java.util.HashMap" resultType="java.util.HashMap">
                SELECT  SQL_CALC_FOUND_ROWS
                        TC.CHAIN_NO				AS chain_no
                        , GET_RISK_GRADE(TC.CHAIN_NO)           AS risk_grade
                        , TC.CHAIN_NM				AS chain_nm
                        , TC.BIZ_NO			        AS biz_no
                        , TC.REMIT_STAT				AS remit_stat
                        , VW.WORK_DATE				AS work_date        
                        , IFNULL(VW.TOT_CNT, 0) 		AS tot_cnt
                        , IFNULL(VW.CONF_CNT, 0) 		AS conf_cnt
                        , IFNULL(VW.CNCL_CNT, 0) 		AS cncl_cnt
                        , IFNULL(VW.CONF_AMT, 0) 		AS conf_amt
                        , IFNULL(VW.CNCL_AMT, 0) 		AS cncl_amt
                        , IFNULL(VW.REMIT_CONF_CNT, 0)          AS remit_conf_cnt
                        , IFNULL(VW.REMIT_CONF_AMT, 0)          AS remit_conf_amt
                        , IFNULL(VW.CNCL_DAY_CNT, 0) 	        AS cncl_day_cnt
                        , IFNULL(VW.CNCL_DAY_AMT, 0) 	        AS cncl_day_amt
                        , IFNULL(VW.CNCL_PRE_CNT, 0) 	        AS cncl_pre_cnt
                        , IFNULL(VW.CNCL_PRE_AMT, 0) 	        AS cncl_pre_amt
                        , IFNULL(VW.RCOUNT, 0) 			AS rcount
                        , IFNULL(VW.ERRCOUNT, 0) 		AS errcount
                        , IFNULL(VW.RESV_AMT, 0) 		AS resv_amt
                        , IFNULL(VW.UNRESV_AMT, 0) 		AS unresv_amt
                        , IFNULL(CARD_FEE_AMT, 0) 	        AS card_fee_amt
                        , IFNULL(CARD_RESV_AMT, 0)              AS card_resv_amt
                        , IFNULL(WD_BASE_AMT, 0) 	        AS wd_base_amt
                        , IFNULL(SVC_FEE_AMT, 0)                AS svc_fee_amt
                        , IFNULL(CRD_FEE_AMT, 0)                AS crd_fee_amt
                        , IFNULL(VW.EXC_AMT, 0) 		AS exc_amt
                        , IFNULL(SR.SUB_AMT, 0)		        AS sub_amt
                        , IFNULL(VW.WD_BASE_AMT, 0) + IFNULL(VW.EXC_AMT, 0)
                        - ( IFNULL(SVC_FEE_AMT, 0) + IFNULL(SR.SUB_AMT, 0))	AS remit_amt
                FROM	(
                                SELECT 	CHAIN_NO, WORK_DATE 
                                        , IFNULL(SUM(TOT_CNT), 0) 		AS TOT_CNT					  					 
                                        , IFNULL(SUM(TOT_AMT), 0) 		AS TOT_AMT
                                        , IFNULL(SUM(CONF_CNT), 0) 	    AS CONF_CNT					  					 
                                        , IFNULL(SUM(CNCL_CNT), 0) 	    AS CNCL_CNT
                                        , IFNULL(SUM(CONF_AMT), 0) 	    AS CONF_AMT				  					 
                                        , IFNULL(SUM(CNCL_AMT), 0) 	    AS CNCL_AMT
                                        , IFNULL(SUM(REMIT_CONF_CNT), 0)	AS REMIT_CONF_CNT
                                        , IFNULL(SUM(REMIT_CONF_AMT), 0)	AS REMIT_CONF_AMT                    
                                        , IFNULL(SUM(CNCL_DAY_CNT), 0)	AS CNCL_DAY_CNT
                                        , IFNULL(SUM(CNCL_DAY_AMT), 0)	AS CNCL_DAY_AMT
                                        , IFNULL(SUM(CNCL_PRE_CNT), 0)	AS CNCL_PRE_CNT
                                        , IFNULL(SUM(CNCL_PRE_AMT), 0)	AS CNCL_PRE_AMT                    
                                        , IFNULL(SUM(RCOUNT), 0) 		AS RCOUNT
                                        , IFNULL(SUM(ERRCOUNT), 0) 	        AS ERRCOUNT
                                        , IFNULL(SUM(RESV_AMT), 0) 	        AS RESV_AMT
                                        , IFNULL(SUM(UNRESV_AMT), 0) 	        AS UNRESV_AMT
                                        , IFNULL(SUM(CARD_FEE_AMT), 0) 	        AS CARD_FEE_AMT
                                        , IFNULL(SUM(CARD_RESV_AMT), 0)         AS CARD_RESV_AMT
                                        , IFNULL(SUM(WD_BASE_AMT), 0) 	        AS WD_BASE_AMT
                                        , IFNULL(SUM(SVC_FEE_AMT), 0)           AS SVC_FEE_AMT
                                        , IFNULL(SUM(CRD_FEE_AMT), 0)           AS CRD_FEE_AMT
                                        , IFNULL(SUM(EXC_AMT), 0) 		AS EXC_AMT
                                  FROM	VW_WITHDRAW_RESV_LIST
                                 WHERE 	WORK_DATE = '2025-04-04'
                                <!-- WHERE 	WORK_DATE = '2025-04-04'  #{sch_work_date}  -->
                                GROUP	BY CHAIN_NO, WORK_DATE 
                        ) VW  
                        LEFT OUTER JOIN (	SELECT  CHAIN_NO, SUM(SUB_AMT) AS SUB_AMT
                                                FROM 	VW_SUB_RESV_LIST
                                                GROUP 	BY CHAIN_NO
                                        ) SR ON SR.CHAIN_NO = VW.CHAIN_NO
                        JOIN TB_CHAIN TC ON TC.CHAIN_NO = VW.CHAIN_NO
                                        AND TC.SVC_STAT = 'O'
                                        AND TC.USE_YN   = 'Y'
                                        AND TC.REMIT_STAT = 'Y'
                                        <if test="sch_agency_no != ''"> 
                                                AND  TC.AGENCY_NO = #{sch_agency_no} 
                                        </if>
                                        <if test="sch_corp_cd != null and sch_corp_cd != ''"> 
                                                AND  TC.CORP_CD = #{sch_corp_cd} 
                                        </if> 
                                        <if test="sch_chain_val != ''">
                                                <choose>
                                                        <when test="sch_chain_gb == 'schgb_biz_no'">
                                                                AND  TC.BIZ_NO  = #{sch_chain_val}
                                                        </when> 
                                                        <when test="sch_chain_gb == 'schgb_chain_nm'">
                                                                AND  TC.CHAIN_NM LIKE CONCAT('%', #{sch_chain_val}, '%')
                                                        </when>
                                                </choose>
                                        </if> 
                                        
                <choose>
                        <when test="sidx != ''">
                                ORDER BY ${sidx} ${sord}
                        </when>
                        <otherwise>
                                ORDER BY 1
                        </otherwise>
                </choose>                
                LIMIT  ${start}, ${end}
        </select>

        <select id="getWDChainSummary" parameterType="java.util.HashMap" resultType="java.util.HashMap">
                SELECT  VW.CHAIN_NO                     AS chain_no
                        , IFNULL(VW.REMIT_CONF_AMT, 0)  as remit_conf_amt
                        , IFNULL(VW.REMIT_CONF_CNT, 0)  as remit_conf_cnt
                        , IFNULL(CARD_RESV_AMT, 0)      as card_resv_amt
                        , IFNULL(CARD_FEE_AMT, 0)       as card_fee_amt
                        , IFNULL(WD_BASE_AMT, 0)        as wd_base_amt
                        , IFNULL(SVC_FEE_AMT, 0)        as svc_fee_amt
                        , IFNULL(CRD_FEE_AMT, 0)        as crd_fee_amt
                        , IFNULL(EXC_AMT, 0)            as exc_amt
                        , IFNULL(SR.SUB_AMT, 0)         as sub_amt
                        , (IFNULL(VW.CARD_RESV_AMT, 0) + IFNULL(VW.EXC_AMT, 0))
                                        - ( IFNULL(VW.SVC_FEE_AMT, 0) + IFNULL(VW.CRD_FEE_AMT, 0) + + IFNULL(SR.SUB_AMT, 0)) as remit_amt
                  FROM  (
                                SELECT 	CHAIN_NO
                                        , IFNULL(SUM(REMIT_CONF_CNT), 0)	AS REMIT_CONF_CNT
                                        , IFNULL(SUM(REMIT_CONF_AMT), 0)	AS REMIT_CONF_AMT         
                                        , IFNULL(SUM(CARD_RESV_AMT), 0) 	AS CARD_RESV_AMT
                                        , IFNULL(SUM(CARD_FEE_AMT), 0) 	        AS CARD_FEE_AMT
                                        , IFNULL(SUM(WD_BASE_AMT), 0) 	        AS WD_BASE_AMT
                                        , IFNULL(SUM(SVC_FEE_AMT), 0)           AS SVC_FEE_AMT
                                        , IFNULL(SUM(CRD_FEE_AMT), 0)           AS CRD_FEE_AMT
                                        , IFNULL(SUM(EXC_AMT), 0) 		AS EXC_AMT
                                FROM	VW_WITHDRAW_RESV_LIST
                                WHERE 	WORK_DATE = #{sch_card_work_date} 
                                AND  CHAIN_NO  = #{sch_card_chain_no} 
                                GROUP	BY CHAIN_NO, WORK_DATE  
                        ) VW  
                        LEFT OUTER JOIN (	
                                SELECT  CHAIN_NO, SUM(SUB_AMT) AS SUB_AMT
                                FROM 	VW_SUB_RESV_LIST
                                WHERE  CHAIN_NO = #{sch_card_chain_no} 
                                GROUP 	BY CHAIN_NO
                        ) SR ON SR.CHAIN_NO = VW.CHAIN_NO
                 LIMIT  1
        </select>

        <select id="getWDCardSummary" parameterType="java.util.HashMap" resultType="java.util.HashMap">
                SELECT 	SQL_CALC_FOUND_ROWS
                        CARD_ACQ                                AS card_acq
                        , GET_CODE_NM('CARD_ACQ', CARD_ACQ)     AS card_acq_nm
                        , IFNULL(SUM(TOT_CNT), 0) 		AS tot_cnt					  					 
                        , IFNULL(SUM(TOT_AMT), 0) 		AS tot_amt
                        , IFNULL(SUM(CONF_CNT), 0) 	        AS conf_cnt					  					 
                        , IFNULL(SUM(CNCL_CNT), 0) 	        AS cncl_cnt
                        , IFNULL(SUM(CONF_AMT), 0) 	        AS conf_amt				  					 
                        , IFNULL(SUM(CNCL_AMT), 0) 	        AS cncl_amt
                        , IFNULL(SUM(REMIT_CONF_CNT), 0)	AS remit_conf_cnt
                        , IFNULL(SUM(REMIT_CONF_AMT), 0)	AS remit_conf_amt                    
                        , IFNULL(SUM(CNCL_DAY_CNT), 0)	        AS cncl_day_cnt
                        , IFNULL(SUM(CNCL_DAY_AMT), 0)	        AS cncl_day_amt
                        , IFNULL(SUM(CNCL_PRE_CNT), 0)	        AS cncl_pre_cnt
                        , IFNULL(SUM(CNCL_PRE_AMT), 0)	        AS cncl_pre_amt                    
                        , IFNULL(SUM(RCOUNT), 0) 		AS rcount
                        , IFNULL(SUM(ERRCOUNT), 0) 	        AS errcount
                        , IFNULL(SUM(RESV_AMT), 0) 	        AS resv_amt
                        , IFNULL(SUM(UNRESV_AMT), 0) 	        AS unresv_amt
                        , IFNULL(SUM(WD_BASE_AMT), 0) 	        AS wd_base_amt
                        , IFNULL(SUM(SVC_FEE_AMT), 0)           AS svc_fee_amt
                        , IFNULL(SUM(EXC_AMT), 0) 	        AS exc_amt
                  FROM	VW_WITHDRAW_RESV_LIST
                 WHERE 	WORK_DATE = #{sch_card_work_date} 
                   AND  CHAIN_NO = #{sch_card_chain_no} 
                 GROUP	BY CARD_ACQ, GET_CODE_NM('CARD_ACQ', CARD_ACQ) 
                <choose>
                        <when test="sidx != ''">
                                ORDER BY ${sidx} ${sord}
                        </when>
                        <otherwise>
                                ORDER BY 1
                        </otherwise>
                </choose>                
                LIMIT  ${start}, ${end}  
        </select>
 
        <select id="getWDResvList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
                SELECT  SQL_CALC_FOUND_ROWS
                        WD.WD_NO                AS wd_no
                        , WD.WD_STATUS          AS wd_status
                        , CWS.CODE_NM           AS wd_status_nm
                        , WD.WORK_DATE          AS work_date
                        , WD.CHAIN_NO           AS chain_no
                        , TC.CHAIN_NM           AS chain_nm
                        , WD.DOCU_SEQ           AS docu_seq
                        , WD.CARD_ACQ           AS card_acq
                        , ACQ.CODE_NM           AS card_acq_nm
                        , WD.CARD_REG_NO        AS card_reg_no
                        , WD.CONF_NO            AS conf_no
                        , WD.CONF_GB            AS conf_gb
                        , CASE WHEN WD.CONF_GB = 'A' THEN '승인' ELSE '취소' END AS conf_gb_nm
                        , WD.CONF_DTTM          AS conf_dttm
                        , WD.CONF_AMT           AS conf_amt
                        , WD.CARD_BUY_FLAG      AS card_buy_flag
                        , WD.CARD_BUY_DATE      AS card_buy_date
                        , WD.CARD_FEE_RATE      AS fard_fee_rate
                        , WD.CARD_FEE_AMT       AS card_fee_amt
                        , WD.CARD_RESV_AMT      AS card_resv_amt
                        , WD.CARD_RESV_DAY      AS card_resv_day
                        , WD.CARD_RESV_DATE     AS card_resv_date
                        , WD.SVC_FEE_RATE       AS svc_fee_rate
                        , WD.SVC_FEE_AMT        AS svc_fee_amt
                        , WD.WD_BASE_AMT        AS wd_base_amt
                        , WD.CRD_FEE_RATE       AS crd_fee_rate
                        , WD.CRD_FEE_AMT        AS crd_fee_amt
                        , WD.SUB_FLAG           AS sub_flag
                        , IFNULL(WD.REMIT_AMT, 0)       AS remit_amt
                        , IFNULL(WD.REMIT_SEQ, '')      AS remit_seq
                        , IFNULL( WD.REMIT_DTTM, '')    AS remit_dttm
                        , IFNULL(WD.DEPOSIT_FLAG, '')   AS deposit_flag
                        , IFNULL(WD.BANK_IN_DATE, '')   AS bank_in_date
                        , IFNULL(WD.CARDSALES_FG, '')   AS cardsales_fg
                        , WD.USE_YN                     AS use_yn
                        , IFNULL(WD.WD_MEMO, '')        AS wd_memo
                        , WD.CLOSE_YN                   AS close_yn
                        , IFNULL(WD.UPT_DTTM, WD.ENT_DTTM)              AS upt_dttm
                        , IFNULL(WD.ENT_USER_ID,  WD.UPT_USER_ID)       AS upt_user_id
                FROM  TB_WITHDRAW WD
                        JOIN TB_CHAIN   TC ON TC.CHAIN_NO = WD.CHAIN_NO
                        JOIN TB_CODE CWS ON CWS.CODE = WD.WD_STATUS
                                AND CWS.CODE_GRP_CD = 'WD_STATUS'
                        JOIN TB_CODE ACQ ON ACQ.CODE = WD.CARD_ACQ
                                AND ACQ.CODE_GRP_CD = 'CARD_ACQ'
                WHERE  1=1
                AND  WD.WORK_DATE    = #{sch_list_work_date} 
                AND  WD.CHAIN_NO        = #{sch_list_chain_no} 
                AND  WD.WD_STATUS    LIKE 'W%'
                <if test="sch_list_wd_status != ''"> 
                        AND  WD.WD_STATUS    = #{sch_list_wd_status} 
                </if>
                <if test="sch_chain_nm != ''"> 
                        AND  WD.CARD_ACQ IN (#{sch_chain_nm})
                </if>
                <if test="sch_list_conf_val != ''">
                        <choose>
                                <when test="sch_list_gb == 'sch_list_conf_no'">
                                        AND WD.CONF_NO  = #{sch_list_conf_val}
                                </when>
                                <when test="sch_list_gb == 'sch_list_card_no'">
                                        AND WD.CARD_NO  = #{sch_list_conf_val}
                                </when>
                                <when test="sch_list_gb == 'sch_list_conf_amt'">
                                        AND WD.CONF_AMT  = #{sch_list_conf_val}
                                </when>
                        </choose>
                </if>  
                <choose>
                        <when test="sidx != ''">
                                ORDER BY ${sidx} ${sord}
                        </when>
                        <otherwise>
                                ORDER BY 1
                        </otherwise>
                </choose>                
                LIMIT  ${start}, ${end}
        </select>

        <update id="callScrapTransDeliDocu" parameterType="com.web.manage.trans.domain.TransProcessVO" statementType="CALLABLE">
                { 
                        CALL PRC_SCRAP_TRANS_DELI_DOCU(
                                #{chainNo, mode=IN, jdbcType=VARCHAR}
                                , #{userId, mode=IN, jdbcType=VARCHAR}
                                , #{resultCode, mode=OUT, jdbcType=INTEGER, javaType=java.lang.Integer}
                                , #{resultMsg, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
                        ) 
                }
        </update>

</mapper>