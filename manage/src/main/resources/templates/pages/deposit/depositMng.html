<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}" layout:fragment="Content">
  <head>
    <title>사전정산 관리</title>
    <script src="/vendors/tinymce/tinymce.min.js"></script>
    <script src="/vendors/datatables.net/dataTables.min.js"></script>
    <script src="/vendors/datatables.net-bs5/dataTables.bootstrap5.min.js"></script>
    <script src="/vendors/datatables.net-fixedcolumns/dataTables.fixedColumns.min.js"></script>
    <script src="/vendors/dropzone/dropzone-min.js"></script>
    <script src="/js/jquery.form.js"></script> 
    <link rel="stylesheet" href="/vendors/datatables.net-bs5/dataTables.bootstrap5.min.css" />    
    <!-- DataTables Select CSS 추가 -->
    <link rel="stylesheet" href="/css/custom-salesm.css" />

    <script th:inline="none">      
      $(document).ready(function () {           
        $('#frm_sch').onLoadFunction();      
        $('#frm_sch_card').onLoadFunction();      
        $('#frm_sch_list').onLoadFunction();      

        callAjax('/common/getCreditCorpList', "", fn_corp_list_setting);
        function fn_corp_list_setting(data) {
          codeSetting('CORP_CD', data.data, '#sch_corp_cd', '여신사', '', ''); 
        }
        // Set default values for sch_reg_sdt and sch_reg_edt
        var toDay = returnDate('today');  
        $('#sch_resv_date').val(toDay);
        // $('#sch_list_conf_date').val(toDay);
        $('#change_resv_date').val(toDay);

        // Enter key event for sch_chain_nm
        $('#sch_chain_nm').on('keypress', function(e) {
          if (e.which === 13) {
            $('#btn_search').click();
          }
        });

        $('#btn_search').click(function () {             
          tbl_depo_resv_summ.ajax.reload();
          fn_default_clear();
        });  

        $('#btn_list_search').click(function () {   
          tbl_depo_resv_list.ajax.reload();
        }); 

        var tbl_depo_resv_summ = $('#tbl_depo_resv_summ').DataTable({
            processing: true,
            serverSide: true,
            select: true, // select 옵션은 DataTables Select 확장이 필요할 수 있습니다. 여기서는 체크박스 동작과 직접 관련은 적습니다. 
            ajax: {
              url: '/deposit/deposit/depoMng/depositSummary',
              contentType: 'application/json',
              dataType: 'JSON',
              type: 'POST',
              data: function (postData) {
                  var formData = $('#frm_sch').serializeObject(); // serializeObject는 jQuery 플러그인일 수 있습니다.
                  Object.assign(postData, formData);
                  return JSON.stringify(postData);
              },
              dataSrc: function (json) {
                  // totalSummary 저장
                  totalSumm = json.totalSumm || {};
                  return json.data;
              },
              // 서버 에러 처리 등 추가 가능
              error: function(jqXHR, textStatus, errorThrown) {
                  console.error("DataTables Ajax Error: ", textStatus, errorThrown);
                  // 사용자에게 에러 메시지 표시 등
              }
            },
            columns: [
              {
                  data: 'chain_no',
                  render: function(data, type, row, meta) {
                        // 각 행의 체크박스 생성. 고유 값(여기서는 chain_no)을 value로 사용
                        rowno = meta.row + meta.settings._iDisplayStart + 1;
                        return '<span>' + rowno + '&nbsp;<input type="checkbox" class="form-check-input row-checkbox" value="' + data + '"></span>';
                  },
                  orderable: false,
                  className: 'text-center dt-body-center' // DataTables 1.10+ 권장 클래스
              }
              , { data: 'chain_nm' }
              , { data: 'biz_no' }                
              , { data: 'conf_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { data: 'card_resv_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              // , { data: 'card_resv_amt_remit', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { data: 'depo_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { 
                data: 'depo_gap_amt_remit', 
                render: function(data, type, row) {
                  var formatted = $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                  if (data < 0) {
                    return '<span style="color: blue; font-weight: bold;">' + formatted + '</span>';
                  } else if (data > 0) {
                    return '<span style="color: red; font-weight: bold;">' + formatted + '</span>';
                  }
                  return formatted;
                }
              } 
              , { 
                data: 'credit_amt', 
                render: function(data, type, row) {
                  var formatted = $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                  if (row.credit_gap_amt >= 10000) {
                    return '<span style="color: red; font-weight: bold;">' + formatted + '</span>';
                  } else if (row.credit_gap_amt > 1000) {
                    return '<span style="color: blue;">' + formatted + '</span>';
                  }
                  return formatted;
                }
              } 
            ],
            columnDefs: [
                { targets: 0, width: '40px', className: 'text-center dt-body-center' } // 중앙 정렬 확인
                , { targets: 1, width: '160px', className: 'text-left px-1' }
                , { targets: 2, width: '100px', className: 'text-center px-1' }  
                , { targets: 3, width: '110px', className: 'text-right px-1 dt-body-right' }
                , { targets: 4, width: '110px', className: 'text-right px-1 dt-body-right' }
                , { targets: 5, width: '110px', className: 'text-right px-1 dt-body-right' }                
                , { targets: 6, width: '110px', className: 'text-right px-1 dt-body-right' }
                , { targets: 7, width: '110px', className: 'text-right px-1 dt-body-right' }
            ],
            order: [[0, 'desc']], // 기본 정렬 설정
            paging: true,
            lengthChange: false,
            searching: false,
            ordering: true,
            info: false, // 필요에 따라 true로 변경
            autoWidth: false,
            responsive: true, // 이미 위에서 설정됨
            scrollCollapse: false,
            scrollY: '340px',
            pageLength: 100,
            language: {
                emptyTable: '데이터가 없습니다.',
                zeroRecords: '일치하는 데이터가 없습니다.',
                loadingRecords: '로딩중...',
                processing: '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">처리중...</span></div>', // 로딩/처리중 시각적 표시 개선
            },
            footerCallback: function (row, data, start, end, display) {
                var api = this.api();
                const renderNumber = $.fn.dataTable.render.number(',', '.', 0, '').display;
                const colMap = {
                    3: 'conf_amt',
                    4: 'card_resv_amt',
                    // 5: 'card_resv_amt_remit',
                    5: 'depo_amt',
                    6: 'depo_gap_amt_remit', 
                    7: 'credit_amt',
                };

                Object.entries(colMap).forEach(([colIdx, key]) => {
                    const footer = api.column(Number(colIdx)).footer();
                    if (footer) {
                        const val = totalSumm[key] || 0;
                        $(footer).html(renderNumber(val));
                    }
                }); 
            },
            // =============================================================
            // 중요: 테이블이 다시 그려질 때마다 체크박스 상태를 업데이트
            // =============================================================
            drawCallback: function( settings ) {
                // 1. 헤더 체크박스 상태 초기화 (선택 사항: 페이지 넘길 때마다 초기화할지 결정)
                // $('#check_all').prop('checked', false); // 필요하다면 주석 해제

                // 2. 현재 페이지의 모든 행 체크박스가 선택되었는지 확인하여 헤더 체크박스 상태 업데이트
                updateCheckAllState();
            }
        });

        // --- 전체 선택/해제 체크박스 클릭 이벤트 ---
        $('#check_all').on('click', function(){
            var isChecked = this.checked;
            // 현재 페이지의 모든 행 체크박스를 찾아서 상태 변경
            tbl_depo_resv_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
        });

        // --- 각 행의 체크박스 클릭 이벤트 (이벤트 위임 사용) ---
        $('#tbl_depo_resv_summ tbody').on('click', '.row-checkbox', function(){
            // 개별 체크박스 클릭 시 '전체 선택' 체크박스 상태 업데이트
            updateCheckAllState();
        });

        // --- '전체 선택' 체크박스 상태 업데이트 함수 ---
        function updateCheckAllState() {
            var $rowCheckboxes = tbl_depo_resv_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox');
            var totalCheckboxes = $rowCheckboxes.length;
            var checkedCheckboxes = $rowCheckboxes.filter(':checked').length;

            // 모든 체크박스가 선택되었는지 확인
            var allChecked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
            $('#check_all').prop('checked', allChecked);

            // 하나라도 선택된 경우 vs 모두 선택되지 않은 경우 (선택 사항: indeterminate 상태 구현)
            if (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes) {
                $('#check_all').prop('indeterminate', true); // 일부만 선택되었을 때 중간 상태 표시
            } else {
                $('#check_all').prop('indeterminate', false);
            }
        }

        // serializeObject 함수가 없다면 추가 (간단 버전)
        if (typeof $.fn.serializeObject !== 'function') {
            $.fn.serializeObject = function() {
              var o = {};
              var a = this.serializeArray();
              $.each(a, function() {
                  if (o[this.name]) {
                      if (!o[this.name].push) {
                          o[this.name] = [o[this.name]];
                      }
                      o[this.name].push(this.value || '');
                  } else {
                      o[this.name] = this.value || '';
                  }
              });
              return o;
            };
        } 
 
        $('#tbl_depo_resv_summ').on('click', 'tr', function (e) {          
          if ($(this).hasClass('selected')) {
              $(this).removeClass('selected');
          } else {
              tbl_depo_resv_summ.$('tr.selected').removeClass('selected');
              $(this).addClass('selected');
          } 
          // 수정된 부분: 클릭된 셀 정보 가져오기
          var clickedCell = $(e.target).closest('td');
          var clickedColumnIndex = clickedCell.index();
          var row = tbl_depo_resv_summ.row(this).data();
          $('#frm_sch_card')[0].reset();   
          $('#frm_sch_list')[0].reset();
          
          $('#sch_card_chain_no').val(row.chain_no);
          $('#sch_list_chain_no').val(row.chain_no);   // list 검색 조건

          $('#select_chain_nm').text(row.chain_nm ); // 가맹점명 설정
          
          $('#sch_card_resv_date').val($('#sch_resv_date').val());   // 카드 작업일 설정
          $('#sch_list_resv_date').val($('#sch_resv_date').val());   // list 작업일 설정           
 
          $('#tbl_card_summ').DataTable().ajax.reload(); 

          // var formData = $('#frm_sch_card').serializeObject();    
          var formData ={
            sch_chain_no   : row.chain_no, 
					  sch_depo_date	 : $('#sch_resv_date').val(),
          }      
          callAjaxJson('/deposit/deposit/depoMng/chainDepositStatus', formData, fn_chainDepoStatus);

          var formData2 ={
            select_chain_no   : row.chain_no, 
					  sch_resv_date	 : $('#sch_resv_date').val(),
          }      
          callAjax('/deposit/deposit/depoMng/getSearchConfDate', formData2, fn_list_search_date_setting);

          if ($('#sch_list_chain_no').val() && $('#sch_list_resv_date').val()) {
            tbl_depo_resv_list.ajax.reload();
          } 
        });  

        function fn_chainDepoClear(){
          $('#chain_depo_amt').val('0');
          $('#credit_depo_amt').val('0');
          $('#gap_amt').val('0');
          $('#crd_remit_fee_amt').val('0');
          $('#crd_unremit_sub_amt').val('0');
          $('#crd_exc_amt').val('0');
        }
        
        function fn_chainDepoStatus(data){
          // console.log(data.data); 
          var depoStatus = data.data || {};
          // console.log(depoStatus.chain_depo_amt);
          // console.log(Number(depoStatus.chain_depo_amt).toLocaleString());

          $('#chain_depo_amt').val(depoStatus.chain_depo_amt ? $.fn.dataTable.render.number(',', '.', 0, '').display(depoStatus.chain_depo_amt) : '0');
          $('#credit_depo_amt').val(depoStatus.credit_depo_amt ? $.fn.dataTable.render.number(',', '.', 0, '').display(depoStatus.credit_depo_amt) : '0');

          if (depoStatus.gap_amt) {
            var gapAmt = Number(depoStatus.gap_amt);
            var formatted = $.fn.dataTable.render.number(',', '.', 0, '').display(gapAmt);
            if (gapAmt < 0) {
              $('#gap_amt').val(formatted).css({'color': 'blue', 'font-weight': 'bold'});
            } else if (gapAmt > 0) {
              $('#gap_amt').val(formatted).css({'color': 'red', 'font-weight': 'bold'});
            } else {
              $('#gap_amt').val(formatted).css({'color': '', 'font-weight': ''});
            }
          } else {
            $('#gap_amt').val('0').css({'color': '', 'font-weight': ''});
          }
          $('#crd_remit_fee_amt').val(depoStatus.crd_remit_fee_amt ? $.fn.dataTable.render.number(',', '.', 0, '').display(depoStatus.crd_remit_fee_amt) : '0');
          $('#crd_unremit_sub_amt').val(depoStatus.crd_unremit_sub_amt ? $.fn.dataTable.render.number(',', '.', 0, '').display(depoStatus.crd_unremit_sub_amt) : '0');
          $('#crd_exc_amt').val(depoStatus.crd_exc_amt ? $.fn.dataTable.render.number(',', '.', 0, '').display(depoStatus.crd_exc_amt) : '0');            
        }

        function fn_list_search_date_setting(data){
          var searchDate = data.data || {};          
          $('#sch_list_conf_sdt').val(searchDate.conf_sdt);
          $('#sch_list_conf_edt').val(searchDate.conf_edt);          
        }

        $('#btn_deposit').click(function () {
          var selectedChainNos = [];
          // Iterate through checked checkboxes in the current page
          tbl_depo_resv_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').each(function () {
            selectedChainNos.push($(this).val());
          });
          
          var dataParam ="";
          if ($('#deposit_all').is(':checked')) {  
            if (!confirm("모두 입금 처리하시겠습니까?")) {              
              return;
            }
            dataParam ={
              resvDate : $('#sch_resv_date').val(),
              chain_no : 'ALL',
              cardAcq : 'ALL',
            }
          } else {
            if (selectedChainNos.length === 0) {
              alert('입금 처리할 가맹점을 선택하세요.');
              return;
            }
            dataParam ={              
              resvDate : $('#sch_resv_date').val(),
              chainNo : selectedChainNos.join(','),
              cardAcq : 'ALL',
            }  
          } 
          ConfirmdialogToAjax("execute","/deposit/deposit/depoMng/procDepositAdjust", dataParam, fn_deposit_result); 
        });

        $('#btn_deposit_card').click(function () { 

          var selectedChainNo = "";
          var selectedRow = tbl_depo_resv_summ.row('.selected').data();
          if (selectedRow) {
            selectedChainNo = selectedRow.chain_no;
          }


          if (selectedChainNo == "") {
            alert('입금 처리할 가맹점을 선택하세요.');
            return;
          } 
          
          var selectedCardAcqs = [];
          // Iterate through checked checkboxes in the current page
          tbl_card_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').each(function () {
            selectedCardAcqs.push($(this).val());
          });
          
          var dataParam ="";          
          if (selectedCardAcqs.length === 0) {
            alert('입금 처리 할 매입사를 선택하세요.');
            return;
          }
          dataParam ={              
            resvDate : $('#sch_resv_date').val(),
            chainNo : selectedChainNo,
            cardAcq : selectedCardAcqs.join(','),
          }   
          ConfirmdialogToAjax("execute","/deposit/deposit/depoMng/procDepositAdjust", dataParam, fn_deposit_result); 
        });
         
        function fn_deposit_result(data){ 
          Swal.fire({
            title: '성공',
            text: '작업을 정상적으로 완료하였습니다.',
            icon: 'success'
          });
          fn_default_clear();
          tbl_depo_resv_summ.ajax.reload();
        }

        function fn_default_clear(){           
          fn_card_clear();
          fn_list_clear(); 
          $('#select_chain_nm').text('매입사별 입금 예정 리스트');
          $('#deposit_all').prop('checked', false); 
          fn_chainDepoClear();
        }

        function fn_card_clear(){
          $('#frm_sch_card')[0].reset();
          $('#sch_card_chain_no').val('');
          $('#sch_card_resv_date').val('');
          $('#sch_depo_gb').val(''); 
          tbl_card_summ.ajax.reload();
        }

        function fn_list_clear(){ 
          $('#frm_sch_card')[0].reset();
          $('#sch_list_chain_no').val('');
          $('#sch_list_chain_nm').val('');
          $('#sch_list_resv_date').val('');
          $('#sch_list_card_acq').val(''); 
          tbl_depo_resv_list.ajax.reload();
        }
        
        var tbl_card_summ = $('#tbl_card_summ').DataTable({
          processing: true,
          serverSide: true,
          select: true,
          // responsive: true,
          ajax: {
            url: '/deposit/deposit/depoMng/depoCardSummary',
            contentType: 'application/json',
            dataType: 'JSON',
            type: 'POST',
            data: function (postData) {
              formData = $('#frm_sch_card').serializeObject(); 
              Object.assign(postData, formData);
              return JSON.stringify(postData);
            }, 
            // 서버 에러 처리 등 추가 가능
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("DataTables Ajax Error: ", textStatus, errorThrown);
                // 사용자에게 에러 메시지 표시 등
            }
          },
          columns: [
              {
                data: 'card_acq',
                render: function(data, type, row) {                        
                    return '<input type="checkbox" class="form-check-input row-checkbox" value="' + data + '">';
                },
                orderable: false,
                className: 'text-center dt-body-center' // DataTables 1.10+ 권장 클래스
              }
              , { data: 'card_acq_nm' }
              , { data: 'conf_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { data: 'card_fee_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              // , { data: 'card_resv_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { data: 'card_resv_amt_remit', render: $.fn.dataTable.render.number(',', '.', 0, '') }
              , { data: 'depo_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }

              , { 
                data: 'depo_gap_amt_remit', 
                render: function(data, type, row) {
                  if (data < 0) {
                    return '<span style="color: blue;">' + $.fn.dataTable.render.number(',', '.', 0, '').display(data) + '</span>';
                  } else if (data > 0) {
                    return '<span style="color: red; font-weight: bold;">' + $.fn.dataTable.render.number(',', '.', 0, '').display(data) + '</span>';
                  }
                  return $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                } 
              }
          ],
          columnDefs: [            
            { targets: 0, width: '40px', className: 'text-center dt-body-center' } // 중앙 정렬 확인
            , { targets: 1, width: '150px', className: 'text-left px-1' }
            , { targets: 2, width: '130px', className: 'text-right px-1 dt-body-right' } // DataTables 권장 클래스
            , { targets: 3, width: '130px', className: 'text-right px-1 dt-body-right' }
            , { targets: 4, width: '130px', className: 'text-right px-1 dt-body-right' }
            , { targets: 5, width: '130px', className: 'text-right px-1 dt-body-right' }
            , { targets: 6, width: '130px', className: 'text-right px-1 dt-body-right' }
            // , { targets: 7, width: '130px', className: 'text-right px-1 dt-body-right' }
          ],
          order: [[1, 'asc']],
          paging: false,
          lengthChange: false,
          searching: false,
          ordering: true,
          autoWidth: false,
          // responsive: false,
          // scrollCollapse: true,
          // pageLength: 15,
          scrollY: '320px',
          info: false,
          language: {
            emptyTable: '데이터가 없습니다.',
            search: '검색:',
            zeroRecords: '일치하는 데이터가 없습니다.',
            loadingRecords: '로딩중...',
            processing: '처리중...',
          },
          // =============================================================
          // 중요: 테이블이 다시 그려질 때마다 체크박스 상태를 업데이트
          // =============================================================
          drawCallback: function( settings ) {
            updateCheckAllCardState();                  
          }
        });

        // --- 전체 선택/해제 체크박스 클릭 이벤트 ---
        $('#check_all_card').on('click', function(){
            var isChecked = this.checked;
            // 현재 페이지의 모든 행 체크박스를 찾아서 상태 변경
            tbl_card_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
        });

        // --- 각 행의 체크박스 클릭 이벤트 (이벤트 위임 사용) ---
        $('#tbl_card_summ tbody').on('click', '.row-checkbox', function(){
            // 개별 체크박스 클릭 시 '전체 선택' 체크박스 상태 업데이트
            updateCheckAllCardState();
        });

        // --- '전체 선택' 체크박스 상태 업데이트 함수 ---
        function updateCheckAllCardState() {
            var $rowCheckboxes = tbl_card_summ.rows({ page: 'current' }).nodes().to$().find('.row-checkbox');
            var totalCheckboxes = $rowCheckboxes.length;
            var checkedCheckboxes = $rowCheckboxes.filter(':checked').length;

            // 모든 체크박스가 선택되었는지 확인
            var allChecked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
            $('#check_all_card').prop('checked', allChecked);

            // 하나라도 선택된 경우 vs 모두 선택되지 않은 경우 (선택 사항: indeterminate 상태 구현)
            if (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes) {
                $('#check_all_card').prop('indeterminate', true); // 일부만 선택되었을 때 중간 상태 표시
            } else {
                $('#check_all_card').prop('indeterminate', false);
            }
        }         

        $('#tbl_card_summ').on('click', 'tr', function () {            
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            $(this).addClass('selected');
          }

          var row = tbl_card_summ.row(this).data();
          var currentValue = $('#sch_list_card_acq').val();
          var newValue = row.card_acq;
          // console.log('newValue : ' + newValue );
          if (currentValue.includes(newValue)) {
            // Remove the value if it already exists
            // console.log('Remove the value if it already exists : ' + newValue);
            var updatedValue = currentValue.split(',').filter(function (value) {
              return value !== newValue;
            }).join(',');
            $('#sch_list_card_acq').val(updatedValue);
          } else {
            // Add the value if it doesn't exist
            // console.log('Add the value if it does not exist : ' + newValue);
            if (currentValue) {
              $('#sch_list_card_acq').val(currentValue + ',' + newValue);
            } else {
              $('#sch_list_card_acq').val(newValue);
            }
          } 
          // console.log('currentValue : ' + $('#sch_list_card_acq').val() );
          if ($('#sch_list_chain_no').val() && $('#sch_list_resv_date').val()) {
            tbl_depo_resv_list.ajax.reload();
          } 
        });   

        var tbl_depo_resv_list = $('#tbl_depo_resv_list').DataTable({
          processing: true,
          serverSide: true,
          select: true, 
          ajax: {
            url: '/deposit/deposit/depoMng/depoResvList',
            contentType: 'application/json',
            dataType: 'JSON',
            type: 'POST',
            data: function (postData) {
              formData = $('#frm_sch_list').serializeObject();
              Object.assign(postData, formData);
              return JSON.stringify(postData);
            },
          }, 
          columns: [
            {
                data: null,
                render: function (data, type, row, meta) {
                  return meta.row + meta.settings._iDisplayStart + 1;
                },                    
            }, 
            {
                data: 'wd_no',
                render: function(data, type, row) {
                    // 각 행의 체크박스 생성. 고유 값(여기서는 wd_no)을 value로 사용
                    return '<input type="checkbox" class="form-check-input row-checkbox" value="' + data + '">';
                },
                orderable: false,
                className: 'text-center dt-body-center' // DataTables 1.10+ 권장 클래스
            },
            { data: 'wd_no' },
            { data: 'wd_status_nm' },
            { data: 'card_acq_nm' },

            { data: 'card_no' },
            { data: 'card_type_nm' },
            { data: 'conf_gb_nm' },
            { data: 'conf_no' },
            { data: 'conf_dttm' },

            { data: 'card_resv_date' },
            { data: 'conf_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'card_fee_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'card_resv_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'svc_fee_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            
            { data: 'wd_base_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'crd_fee_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'remit_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'wd_memo' },
          ],
          columnDefs: [
            { targets: 0, width: '50', className: 'text-center' },
            { targets: 1, width: '40', className: 'text-center' },
            { targets: 2, width: '150px', className: 'text-left' },
            { targets: 3, width: '100px', className: 'text-center' },
            { targets: 4, width: '100px', className: 'text-center' },

            { targets: 5, width: '140px', className: 'text-center' },
            { targets: 6, width: '80px', className: 'text-center' },
            { targets: 7, width: '80px', className: 'text-center' },
            { targets: 8, width: '100px', className: 'text-center' },
            { targets: 9, width: '200px', className: 'text-center' },
            
            { targets: 10, width: '100px', className: 'text-center' },
            { targets: 11, width: '120px', className: 'text-end' },
            { targets: 12, width: '120px', className: 'text-end' },
            { targets: 13, width: '120px', className: 'text-end' },
            { targets: 14, width: '120px', className: 'text-end' },
            
            { targets: 15, width: '120px', className: 'text-end' },
            { targets: 16, width: '120px', className: 'text-end' },
            { targets: 17, width: '120px', className: 'text-end' },
            { targets: 18, width: '100px', className: 'text-center' },            
          ],
          order: [[2, 'desc']],
          paging: true,
          lengthChange: false,
          searching: false,
          ordering: true,
          autoWidth: true,
          responsive: true,
          scrollCollapse: true,
          pageLength: 50,
          scrollY: '580px',
          info: false,
          language: {
            emptyTable: '데이터가 없습니다.',
            search: '검색:',
            zeroRecords: '일치하는 데이터가 없습니다.',
            loadingRecords: '로딩중...',
            processing: '처리중...',
          },
          
          // =============================================================
          // 중요: 테이블이 다시 그려질 때마다 체크박스 상태를 업데이트
          // =============================================================
          drawCallback: function( settings ) {
              updateCheckAllListState();
          }
        });

        // --- 전체 선택/해제 체크박스 클릭 이벤트 ---
        $('#check_all_list').on('click', function(){
            var isChecked = this.checked;
            // 현재 페이지의 모든 행 체크박스를 찾아서 상태 변경
            tbl_depo_resv_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
        });

        // --- 각 행의 체크박스 클릭 이벤트 (이벤트 위임 사용) ---
        $('#tbl_depo_resv_list tbody').on('click', '.row-checkbox', function(){
            // 개별 체크박스 클릭 시 '전체 선택' 체크박스 상태 업데이트
            updateCheckAllListState();
        });

        $('#tbl_depo_resv_list').on('click', 'tr', function () {            
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $(this).find('.row-checkbox').prop('checked', false);
          } else {
            $(this).addClass('selected');
            $(this).find('.row-checkbox').prop('checked', true);
          }
        });

        // --- '전체 선택' 체크박스 상태 업데이트 함수 ---
        function updateCheckAllListState() {
            var $rowCheckboxes = tbl_depo_resv_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox');
            var totalCheckboxes = $rowCheckboxes.length;
            var checkedCheckboxes = $rowCheckboxes.filter(':checked').length;

            // 모든 체크박스가 선택되었는지 확인
            var allChecked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
            $('#check_all_list').prop('checked', allChecked);

            // 하나라도 선택된 경우 vs 모두 선택되지 않은 경우 (선택 사항: indeterminate 상태 구현)
            if (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes) {
                $('#check_all_list').prop('indeterminate', true); // 일부만 선택되었을 때 중간 상태 표시
            } else {
                $('#check_all_list').prop('indeterminate', false);
            }
        }

        // Change event for change_gb dropdown
        $('#change_gb').on('change', function () {
          var selectedValue = $(this).val();
          if (selectedValue === 'deposit_date') {
            $('#div_deposit_date').show();
            $('#change_wd_status').hide();
          } else if (selectedValue === 'WD_STATUS') {
            $('#div_deposit_date').hide();
            $('#change_wd_status').show();
          }
        });
 
        $('#btn_list_change').click(function () {          
          var selectedWdNo = [];
          tbl_depo_resv_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').each(function () {
            selectedWdNo.push($(this).val());
          });

          if (selectedWdNo.length === 0) {
            alert('변경 건을 선택해주세요');
            return;
          }

          var dataParam = {
            wdNo: selectedWdNo.join(','),
            changeResvDate: $('#change_resv_date').val(), 
          };

          var resvDate = $('#change_resv_date').val();
          if (!resvDate) {
            alert('변경 작업일을 입력하세요.');
            return;
          }
          if (resvDate < toDay ){
            alert('변경일은 금일 이후로 변경 가능합니다.');
            return;
          }
          
          ConfirmdialogToAjax("execute", "/deposit/deposit/depoMng/changeResvDate", dataParam, fn_change_result);
          
        });

        function fn_change_result(data){
          swal('성공', '작업을 정상적으로 완료하였습니다.', 'success');
          fn_default_clear();
          tbl_depo_resv_summ.ajax.reload();
        }
        
        // Excel download button click event
        $('#btn_list_excel').click(function () {
          var formData = $('#frm_sch_list').serializeObject();
          $('#globalLoadingBar').show();
          $.ajax({
            url: '/deposit/deposit/depoMng/depoResvExcel',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            xhrFields: {
              responseType: 'blob'
            },
            success: function (data, status, xhr) {
              var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              var link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = '입금예정 상세 리스트.xlsx';
              link.click();
            },
            error: function (xhr, status, error) {
              alert('Excel download failed.');
            },
            complete: function () {
              $('#globalLoadingBar').hide();
            }
          });
        });  
        
        $('#chain_depo_amt').on('click', function () {
          var depoAmtValue = parseFloat($(this).val().replace(/,/g, '')) || 0; // Remove commas and parse as float
          if (depoAmtValue > 0) { 
            $('#modal_depo').modal('show'); // Show the modal   
            $('#sch_depo_gb').val('CHAIN');
          }
        });

        $('#credit_depo_amt').on('click', function () {
          var depoAmtValue = parseFloat($(this).val().replace(/,/g, '')) || 0; // Remove commas and parse as float
          if (depoAmtValue > 0) { 
            $('#modal_depo').modal('show'); // Show the modal   
            $('#sch_depo_gb').val('CREDIT');
          }
        });

        // 모달 창 표시될때 초기화 처리
        $('#modal_depo').on('shown.bs.modal', function() {  
          // 모달 열릴 때 첫 번째 포커스 가능 요소로 이동          
          $(this).data('trigger-element', document.activeElement);
          if ($.fn.DataTable.isDataTable('#tbl_depo_list')) {
            $('#tbl_depo_list').DataTable().destroy();
          }          
          
          var tbl_depo_list = $('#tbl_depo_list').DataTable({
              processing: true,
              serverSide: true,
              select: true,
              responsive: true,
              ajax: {
                  url: '/deposit/deposit/depoMng/depositList',
                  contentType: 'application/json',
                  dataType: 'JSON',
                  type: 'POST',
                  data: function (postData) {
                    var formData = { 
                      sch_gb      : $('#sch_depo_gb').val(),
                      sch_chain_no: $('#sch_card_chain_no').val(),
                      sch_date    : $('#sch_resv_date').val(),
                    };
                    Object.assign(postData, formData);
                    return JSON.stringify(postData);
                  },
                },
              columns: [
                { 
                    data: null,
                    render: function (data, type, row, meta) {
                      return meta.row + meta.settings._iDisplayStart + 1;
                    }
                },
                {
                  data: 'deposit_no',
                  render: function(data, type, row) {                    
                      return '<input type="checkbox" class="form-check-input row-checkbox" value="' + data + '">';
                  },
                  orderable: false,
                  className: 'text-center dt-body-center' // DataTables 1.10+ 권장 클래스
                },
                { data: 'gubun' },
                { data: 'bank_cd_nm' },
                { data: 'send_corp_nm' },
                { data: 'bank_in_dttm' },
                { data: 'in_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },              
                { data: 'remark' },
              ],
              columnDefs: [
                { targets: 0, width: '40px', className: 'text-center' },
                { targets: 1, width: '40px', className: 'text-center' },
                { targets: 2, width: '90px', className: 'text-center' },
                { targets: 3, width: '110px', className: 'text-left' },
                { targets: 4, width: '120px', className: 'text-left' },
                { targets: 5, width: '200px', className: 'text-center' },
                { targets: 6, width: '120px', className: 'text-end' },
                { targets: 7, width: '300px', className: 'text-left' },
              ],
              order: [[0, 'desc']],
              paging: true,
              lengthChange: false,
              searching: false,
              ordering: true,
              autoWidth: false,
              responsive: true,
              scrollCollapse: false,
              pageLength: 10,
              scrollY: '280px',
              info: false,
              language: {
                emptyTable: '데이터가 없습니다.',
                zeroRecords: '일치하는 데이터가 없습니다.',
                loadingRecords: '로딩중...',
                processing: '처리중...',
              },
              // =============================================================
              // 중요: 테이블이 다시 그려질 때마다 체크박스 상태를 업데이트
              // =============================================================
              drawCallback: function( settings ) {
                  updateCheckAllListState();
              }
          });

          // --- 전체 선택/해제 체크박스 클릭 이벤트 ---
          $('#check_all_depo_list').on('click', function(){
              var isChecked = this.checked;
              // 현재 페이지의 모든 행 체크박스를 찾아서 상태 변경
              tbl_depo_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
          });

          // --- 각 행의 체크박스 클릭 이벤트 (이벤트 위임 사용) ---
          $('#tbl_depo_list tbody').on('click', '.row-checkbox', function(){
              // 개별 체크박스 클릭 시 '전체 선택' 체크박스 상태 업데이트
              updateCheckAllDepoListState();
          });

          $('#tbl_depo_list').on('click', 'tr', function () {      
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            } else {
                tbl_depo_list.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }       
            // if ($(this).hasClass('selected')) {
            //   $(this).removeClass('selected');
            //   $(this).find('.row-checkbox').prop('checked', false);
            // } else {
            //   $(this).addClass('selected');
            //   $(this).find('.row-checkbox').prop('checked', true);
            // }
          });

          // --- '전체 선택' 체크박스 상태 업데이트 함수 ---
          function updateCheckAllDepoListState() {
              var $rowCheckboxes = tbl_depo_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox');
              var totalCheckboxes = $rowCheckboxes.length;
              var checkedCheckboxes = $rowCheckboxes.filter(':checked').length;

              // 모든 체크박스가 선택되었는지 확인
              var allChecked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
              $('#check_all_depo_list').prop('checked', allChecked);

              // 하나라도 선택된 경우 vs 모두 선택되지 않은 경우 (선택 사항: indeterminate 상태 구현)
              if (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes) {
                  $('#check_all_depo_list').prop('indeterminate', true); // 일부만 선택되었을 때 중간 상태 표시
              } else {
                  $('#check_all_depo_list').prop('indeterminate', false);
              }
          }
          // 첫 번째 포커스 가능 요소로 이동
          $(this).find('button:not([disabled]), input:not([disabled])').first().focus();         
          
          $('#btn_depo_delete').click(function () {          
            var selectedDepoNO = [];
            tbl_depo_list.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').each(function () {
              selectedDepoNO.push($(this).val());
            });

            if (selectedDepoNO.length === 0) {
              alert('삭제 건을 선택해주세요');
              return;
            }

            var dataParam = {
              depositNo: selectedDepoNO.join(',') 
            }; 
            
            ConfirmdialogToAjax("execute", "/deposit/deposit/depoMng/deleteDepoData", dataParam, fn_depo_delete_result);
            
          });

          function fn_depo_delete_result(data){
            swal('성공', '작업을 정상적으로 완료하였습니다.', 'success');             
            tbl_depo_list.ajax.reload();
          }
        });

        // 모달이 닫힐 때 포커스 복원
        $('#modal_depo').on('hidden.bs.modal', function() {
          var triggerElement = $(this).data('trigger-element');
          if (triggerElement) {
            $(triggerElement).focus();
          } 
          return true; // 모달 닫기 허용
        });


        // 모달 창 표시될때 초기화 처리
        $('#modal_mnul_depo').on('shown.bs.modal', function() {  
          // 모달 열릴 때 첫 번째 포커스 가능 요소로 이동          
          $(this).data('trigger-element', document.activeElement);
          if ($.fn.DataTable.isDataTable('#tbl_mnul_depo_list')) {
            $('#tbl_mnul_depo_list').DataTable().destroy();
          }          
          
          $('#modal_mnul_deposit').DataTable({
            processing: true,
            serverSide: true,
            select: true,
            responsive: true,
            ajax: {
                url: '/deposit/deposit/depoMng/mnulDepositList',
                contentType: 'application/json',
                dataType: 'JSON',
                type: 'POST',
                data: function (postData) {
                  var formData = { 
                    sch_gb      : 'MNUL',
                    sch_chain_no: $('#sch_card_chain_no').val(),
                    sch_date    : $('#sch_resv_date').val(),
                  };
                  Object.assign(postData, formData);
                  return JSON.stringify(postData);
                },
              },
            columns: [
              { 
                  data: 'deposit_no',
                  render: function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                  }
              },
              { data: 'send_corp_nm' },
              { data: 'in_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
              { data: 'bank_in_dttm' },    
              { data: 'remark' },
            ],
            columnDefs: [
              { targets: 0, width: '60px', className: 'text-center' },
              { targets: 1, width: '120px', className: 'text-center' },
              { targets: 2, width: '150px', className: 'text-end' },
              { targets: 3, width: '200px', className: 'text-center' },              
              { targets: 4, width: '120px', className: 'text-left' },
            ],
            order: [[0, 'desc']],
            paging: true,
            lengthChange: false,
            searching: false,
            ordering: true,
            autoWidth: false,
            responsive: true,
            scrollCollapse: false,
            pageLength: 10,
            scrollY: '280px',
            info: false,
            language: {
              emptyTable: '데이터가 없습니다.',
              zeroRecords: '일치하는 데이터가 없습니다.',
              loadingRecords: '로딩중...',
              processing: '처리중...',
            },
          });
          // 첫 번째 포커스 가능 요소로 이동
          $(this).find('button:not([disabled]), input:not([disabled])').first().focus();           
        });

        // 모달이 닫힐 때 포커스 복원
        $('#modal_mnul_deposit').on('hidden.bs.modal', function() {
          var triggerElement = $(this).data('trigger-element');
          if (triggerElement) {
            $(triggerElement).focus();
          } 
          return true; // 모달 닫기 허용
        });
      });
    </script>
  </head>
  <div class="content">     
    <div class="row g-1 mb-1">
      <div class="col-lg-7">
        <div class="card" style="height: 600px;">
          <div class="card-header">          
            <div class="row flex-between-end">
              <div class="col-lg-2 align-self-center">
                <h4 class="mb-0">입금 정산</h4>
              </div>            
              <div class="col-lg-10">
                <form id="frm_sch" name="frm_sch" onsubmit="return false;" novalidate=""> 
                  <div class="row mb-1">
                    <div class="col-sm-12">
                      <div class="input-group input-group-sm mb-1">
                        <div class="col-sm-3">
                          <input class="form-control form-control-sm" id="sch_resv_date" type="text" name="sch_resv_date" istyle="date" maxlength="10" required />
                        </div>   
                        <select class="form-select form-control-sm me-1" id="sch_corp_cd" name="sch_corp_cd" style="width: 75px">
                          <option value="">여신사</option>
                        </select>
                        <input type="text" class="form-control form-control-sm me-1" id="sch_chain_nm" name="sch_chain_nm" style="width:100px" />
                        <button type="button" class="btn btn-primary btn-sm" id="btn_search" name="btn_search">조회</button>
                      </div>
                    </div> 
                  </div> 
                  <div class="row mb-1">
                    <div class="col-sm-3">                      
                    </div>
                    <div class="col-sm-3">
                      <!-- <input type="checkbox" id="sch_deposit_chk" class="form-check-input" checked/>
                      <label for="sch_deposit_chk" class="form-check-label">정산가맹점 만</label> -->
                    </div>
                    <div class="col-sm-3">
                      <input type="checkbox" id="deposit_all" class="form-check-input" />
                      <label for="deposit_all" class="form-check-label">모두 입금처리</label>
                    </div>
                    <div class="col-sm-3 text-end">
                      <button type="button" class="btn btn-success btn-sm" id="btn_deposit" name="btn_deposit">입금 처리</button>                      
                    </div>
                  </div>
                </form>                
              </div>
            </div>          
          </div>
          <div class="card-body pt-0 px-0" style="padding-top: 0px">
            <div class="table-responsive scrollbar">
              <table class="table table-striped table-sm fs-9 mb-0 selectable-table table-hover selectable table-bordered" id="tbl_depo_resv_summ">  
                <thead>
                  <tr>
                    <th class="text-center">
                        <input type="checkbox" id="check_all" class="form-check-input" />
                    </th>
                    <th class="text-center">가맹점 명</th>
                    <th class="text-center">사업자 번호</th>
                    <th class="text-center">매출액</th>
                    <th class="text-center">입금 예정액</th>
                    <!-- <th class="text-center">상환 예정액</th> -->
                    <th class="text-center">입  금  액</th>
                    <th class="text-center">미입금액</th> 
                    <th class="text-center">여신사 입금액</th> 
                  </tr>
                </thead>
                <tbody class="list"></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-center">총계</th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>                     
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>
                  </tr>
                </tfoot>
              </table>
            </div>            
          </div>
        </div>      
      </div>
      <div class="col-lg-5">
        <div class="card" style="height: 600px;">    
          <div class="card-header">            
            <form id="frm_sch_card" name="frm_sch_card" onsubmit="return false;" novalidate="">
              <input id="sch_card_chain_no" type="hidden" name="sch_card_chain_no" readonly="readonly"  value=""/>
              <input id="sch_card_resv_date" type="hidden" name="sch_card_resv_date" value=""/>
              <input id="sch_depo_gb"         type="hidden" name="sch_depo_gb"  value=""/>
            </form>
            <div class="row flex-between-end">              
              <div class="col-lg-10 align-self-center">
                <h5 class="mb-0"><span id="select_chain_nm" style="color: blue;"></span> 매입사별 입금 예정 리스트</h5>
              </div> 
              <div class="col-sm-2">
                <button type="button" class="btn btn-success btn-sm" id="btn_deposit_card" name="btn_deposit_card">입금 처리</button>                      
              </div>
            </div>
          </div>
          <div class="card-body pt-0 px-2" style="padding-top: 0px">
            <div class="row mb-0">
              <div class="table-responsive scrollbar">              
                <table class="table table-striped table-sm fs-9 mb-0 table-hover selectable table-bordered" id="tbl_card_summ">
                  <thead>
                    <tr>  
                      <th rowspan="2" class="text-center" style="vertical-align: middle;">
                        <input type="checkbox" id="check_all_card" class="form-check-input" />
                      </th>
                      <th rowspan="2" class="text-center" style="vertical-align: middle;">카드(매입)사</th>
                      <th colspan="3" class="text-center">입금 정산</th>
                      <th rowspan="2" class="text-center" style="vertical-align: middle;">입금액</th>
                      <th rowspan="2" class="text-center" style="vertical-align: middle;">미입금액</th>
                    </tr>
                    <tr>
                      <th class="text-center">매출액</th>
                      <th class="text-center">카드수수료</th>
                      <th class="text-center">입금예정액</th>
                      <!-- <th class="text-center">상환예정액</th> -->
                    </tr>
                  </thead>
                  <tbody class="list"></tbody>
                </table>              
              </div>
            </div>  
            <div class="mt-2 mb-2 border-bottom pb-1"></div>
            <div class="row mb-1">
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="chain_depo_amt">가맹점 입금</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="chain_depo_amt" type="text" name="chain_depo_amt" value="0" readonly /> 
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="credit_depo_amt">여신사 입금</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="credit_depo_amt" type="text" name="credit_depo_amt" value="0" readonly />
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="gap_amt">차액</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="gap_amt" type="text" name="gap_amt" value="0" readonly />
                  </div>
                </div>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="crd_remit_fee_amt">송금수수료</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="crd_remit_fee_amt" type="text" name="crd_remit_fee_amt" value="0" readonly />
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="crd_unremit_sub_amt">차감</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="crd_unremit_sub_amt" type="text" name="crd_unremit_sub_amt" value="0" readonly />
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="crd_exc_amt">과송금</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="crd_exc_amt" type="text" name="crd_exc_amt" value="0" readonly />
                  </div>
                </div>
              </div>
            </div> 
          </div> 
        </div>      
      </div>        
    </div>     
    <div class="row g-1 mb-1">
      <div class="card">
        <div class="card-header"> 
          <div class="row flex-between-end">              
            <div class="col-lg-1 align-self-center">
              <h5 class="mb-0">상세 List</h5>
            </div>     
            <div class="col-lg-11">
              <form id="frm_sch_list" name="frm_sch_list" onsubmit="return false;" novalidate=""> 
                <input id="sch_list_chain_no"   type="hidden" name="sch_list_chain_no" value=""/>
                <input id="sch_list_chain_nm"   type="hidden" name="sch_list_chain_nm" value="" />
                <input id="sch_list_resv_date"  type="hidden" name="sch_list_resv_date" value=""/>
                <input id="sch_list_card_acq"   type="hidden" name="sch_list_card_acq" value="" />
                <div class="row mb-1">
                  <div class="col-sm-3">
                    <div class="input-group input-group-sm mb-1"> 
                      <div class="col-sm-5">
                        <input class="form-control form-control-sm me-1" id="sch_list_conf_sdt" type="text" name="sch_list_conf_sdt" istyle="date" maxlength="10" required />
                      </div>   
                      <span class="input-group-text">~</span>
                      <div class="col-sm-5">
                        <input class="form-control form-control-sm me-1" id="sch_list_conf_edt" type="text" name="sch_list_conf_edt" istyle="date" maxlength="10" required />
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1"> 
                      <select class="form-select form-control-sm me-1" id="sch_remit_yn" name="sch_remit_yn" style="width: 90px">
                        <option value="A">전체</option>
                        <option value="Y">정산확정</option>
                        <option value="N">미확정</option>
                      </select>                     
                      <select class="form-select form-control-sm me-1" id="sch_list_gb" name="sch_list_gb" style="width: 120px">
                        <option value="sch_list_gb_conf_no">승인 번호</option>
                        <option value="sch_list_gb_card_no">카드 번호</option>
                        <option value="sch_list_gb_conf_amt">승인 금액</option>
                      </select>
                      <input type="text" class="form-control form-control-sm me-1" id="sch_list_gb_conf_val" name="sch_list_gb_conf_val" style="width:100px" />                        
                      <button type="button" class="btn btn-primary btn-sm" id="btn_list_search" name="btn_list_search">조회</button> 
                    </div>
                  </div> 
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <div class="col-sm-3"></div>
                      <label class="col-sm-3 col-form-label col-form-label-sm" for="change_resv_date">입금예정일 변경</label>                       
                      <div class="col-sm-4">
                        <div id="div_deposit_date">
                          <input class="form-control form-control-sm" id="change_resv_date" type="text" name="change_resv_date" istyle="date" maxlength="10" placeholder="변경 작업일" />  
                        </div>  
                      </div>
                      <button type="button" class="btn btn-info btn-sm" id="btn_list_change" name="btn_list_change">변경</button>                                              
                    </div>                             
                  </div>
                  <div class="col-sm-1 text-end"> 
                    <button type="button" class="btn btn-primary btn-sm" id="btn_list_excel" name="btn_list_excel">Excel</button> 
                  </div>    
                </div> 
              </form>
            </div>
          </div>          
        </div>
        <div class="card-body pt-0 px-0" style="padding-top: 0px">
          <div class="table-responsive scrollbar" style="overflow-x: auto; min-width: 1800px;">
            <table class="table table-striped table-sm fs-9 mb-0 selectable-table table-hover selectable table-bordered" id="tbl_depo_resv_list" style="min-width: 2090px; border-collapse: collapse;">    
              <thead>
                  <tr>
                    <th class="text-center" style="width:60px; border:1px solid #dee2e6;">No</th>
                    <th class="text-center" style="width:40px; border:1px solid #dee2e6;">
                      <input type="checkbox" id="check_all_list" class="form-check-input" />
                    </th>
                    <th class="text-center" style="width:150px; border:1px solid #dee2e6;">정산 번호</th> 
                    <th class="text-center" style="width:100px; border:1px solid #dee2e6;">정산 상태</th>
                    <th class="text-center" style="width:100px; border:1px solid #dee2e6;">매입사</th>
                    
                    <th class="text-center" style="width:140px; border:1px solid #dee2e6;">카드번호</th>
                    <th class="text-center" style="width:80px; border:1px solid #dee2e6;">카드유형</th>
                    <th class="text-center" style="width:80px; border:1px solid #dee2e6;">구분</th>
                    <th class="text-center" style="width:100px; border:1px solid #dee2e6;">승인번호</th>
                    <th class="text-center" style="width:200px; border:1px solid #dee2e6;">승인일시</th>
                    
                    <th class="text-center" style="width:100px; border:1px solid #dee2e6;">입금예정일</th>
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">승인금액</th>                    
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">카드수수료</th>
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">입금예정액</th>
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">정산 수수료</th>
                    
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">정산 원금</th>
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">여신수수료</th>
                    <th class="text-center" style="width:120px; border:1px solid #dee2e6;">출금액</th>
                    <th class="text-center" style="width:100px; border:1px solid #dee2e6;">비고</th>
                  </tr>  
              </thead>
              <tbody class="list"></tbody>
            </table>
          </div>
        </div>        
      </div>     
    </div>    
  </div>  

  <div class="modal fade" id="modal_depo" tabindex="-1">
    <div class="modal-dialog modal-xl"> 
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">가맹점 입금 내역</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body"> 
          <div class="table-responsive scrollbar">
            <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_depo_list">
              <thead class="bg-200">
                <tr>
                  <th class="text-center" style="width: 40px;">번호</th>
                  <th class="text-center" style="width: 40px;">
                    <input type="checkbox" id="check_all_depo_list" class="form-check-input" />
                  </th>
                  <th class="text-center" style="width: 90px;">구분</th>
                  <th class="text-center" style="width: 110px;">은행명</th>
                  <th class="text-center" style="width: 120px;">입금처</th>
                  <th class="text-center" style="width: 200px;">입금시간</th> 
                  <th class="text-center" style="width: 120px;">입금액</th>
                  <th class="text-center" style="width: 300px;">비고</th> 
                </tr>
              </thead>
              <tbody class="list"></tbody>
            </table>
          </div> 
          <div class="modal-footer">            
            <button class="btn btn-primary text-start" type="button" id="btn_depo_delete" name="btn_depo_delete">입금 내역 삭제</button>
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" aria-label="모달 닫기">닫기</button>
          </div>          
        </div>
      </div>
    </div>
  </div>  
  
  <div class="modal fade" id="modal_mnul_deposit" tabindex="-2">
    <div class="modal-dialog modal-xl"> 
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">수기 입금 등록 관리</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form class="needs-validation" id="frm_mnul_deposit" name="frm_mnul_deposit" onsubmit="return false;" method="post" novalidate=""> 
          <div class="modal-body"> 
            <div class="table-responsive scrollbar">
              <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_mnul_depo_list">
                <thead class="bg-200">
                  <tr>
                    <th class="text-center" style="width: 60px;">번호</th>
                    <th class="text-center" style="width: 120px;">매입(카드)사</th>
                    <th class="text-center" style="width: 150px;">입금액</th>
                    <th class="text-center" style="width: 200px;">입금일시</th>                     
                    <th class="text-center" style="width: 120px;">등록자</th> 
                  </tr>
                </thead>
                <tbody class="list"></tbody>
              </table>
            </div>
            <div class="row mb-1">
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="mnul_card_acq">매입사</label>
                  <div class="col-sm-8">
                    <select class="form-select form-select-sm" id="mnul_card_acq" name="mnul_card_acq" required>
                      <option value="">선택</option> 
                    </select>
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-4 col-form-label col-form-label-sm" for="mnul_depo_amt">입금액</label>
                  <div class="col-sm-8">
                    <input class="form-control form-control-sm text-end bg-light" id="mnul_depo_amt" type="text" name="mnul_depo_amt" value="0" readonly />
                  </div>
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group input-group-sm mb-1">
                  <button type="button" class="btn btn-info text-end"   id="btn_mnul_depo_clear"><i class="fa fa-check"></i>신규</button>
                  <button type="button" class="btn btn-primary text-end" id="btn_mnul_depo_delete" style="display: none"><i class="fa fa-paste"></i>삭제</button>
                  <button type="button" class="btn btn-primary text-end" id="btn_mnul_depo_create"><i class="fa fa-paste"></i>저장</button>
                </div>
              </div>
            </div>          
            <div class="modal-footer">            
              <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" aria-label="모달 닫기">닫기</button>
            </div>          
          </div>
        </form>
      </div>
    </div>
  </div>

</html>
