<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default}" layout:fragment="Content">
  <head>
    <title>가맹점 관리</title>
    <script src="/vendors/tinymce/tinymce.min.js"></script>
    <script src="/vendors/datatables.net/dataTables.min.js"></script>
    <script src="/vendors/datatables.net-bs5/dataTables.bootstrap5.min.js"></script>
    <script src="/vendors/datatables.net-fixedcolumns/dataTables.fixedColumns.min.js"></script>
    <script src="/vendors/dropzone/dropzone-min.js"></script>
    <script src="/js/jquery.form.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10.4.3/decimal.min.js"></script>

    <link rel="stylesheet" href="/vendors/datatables.net-bs5/dataTables.bootstrap5.min.css" />
    <!-- ? XLSX (SheetJS) 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- DataTables Select CSS 추가 -->
    <link rel="stylesheet" href="/css/custom-salesm.css" />

    <script th:inline="none">

      $(document).ready(function () {
        var editMode = 'create'; // create, update
        $('#frm_chain_list').onLoadFunction();
        $('#frm_loan_mst').onLoadFunction(); 
        $('#frm_prepay').onLoadFunction(); 
        $('#frm_sch_counsel').onLoadFunction(); 
        $('#frm_counsel_mst').onLoadFunction(); 

        var isListClick = false;
        callAjax('/common/totalCodelist', "code_grp_cd=('LOAN_TYPE')", fn_loan_type_setting);
        function fn_loan_type_setting(data) {
          codeSetting('LOAN_TYPE', data.data, '#sch_loan_type', '대출유형', '', ''); 
          codeSetting('LOAN_TYPE', data.data, '#loan_type', '1', '', ''); 
        }

        callAjax('/common/getAgencyList', "", fn_agency_list_setting);
        function fn_agency_list_setting(data) {
          codeSetting('AGENCY_CD', data.data, '#sch_agency_cd', '대리점', '', ''); 
        }  

        callAjax('/common/totalCodelist', "code_grp_cd=('LOAN_CODE') AND CHK_CD1 = '" + $('#sch_loan_type').val() + "'", fn_sch_loan_code_setting);
        function fn_sch_loan_code_setting(data) {
          codeSetting('LOAN_CODE', data.data, '#sch_loan_code', '대출', '', ''); 
        }

        callAjax('/common/totalCodelist', "code_grp_cd=('LOAN_STATUS')", fn_loan_status_setting);
        function fn_loan_status_setting(data) {
          codeSetting('LOAN_STATUS', data.data, '#sch_loan_status', '진행상태', '01', '');
          codeSetting('LOAN_STATUS', data.data, '#loan_status', '1', '', '');
        } 
        callAjax('/common/getCreditCorpList', "", fn_credit_list_setting);
        function fn_credit_list_setting(data) { 
          codeSetting('CORP_CD', data.data, '#sch_corp_cd', '여신사', '', '');
          // codeSetting('CORP_CD', data.data, '#corp_cd', '1', '', '');
        }

        callAjax('/common/totalCodelist', "code_grp_cd=('COUNSEL_CD') AND CHK_CD1='LOAN'", fn_counsel_setting);
        function fn_counsel_setting(data) {
          codeSetting('COUNSEL_CD', data.data, '#sch_counsel_cd', '상담유형', '', '');
          codeSetting('COUNSEL_CD', data.data, '#counsel_cd', '1', '', '');
        }

        // Set default values for sch_cont_sdt and sch_cont_edt
        var toDay = returnDate('today'); // 오늘 날짜 계산
        var thirtyDayAgo = returnDate('thirtyDayAgo'); // 1개월 전 날짜 계산

        $('#sch_cont_sdt').val(thirtyDayAgo);
        $('#sch_cont_edt').val(toDay); 
        $('#cont_dt').val(toDay); 
        $('#loan_sdt').val(toDay); 
        $('#prepay_recv_date').val(toDay); 
        $('#counsel_dt').val(toDay); 

        var tbl_loan_summary = $('#tbl_loan_summary').DataTable({
          processing: true,
          serverSide: true,
          select: true,
          responsive: true,
          ajax: {
            url: '/loan/loan/loanMng/loanSummary',
            contentType: 'application/json',
            dataType: 'JSON',
            type: 'POST',
            data: function (postData) {
              formData = $('#frm_sch_summ_list').serializeObject(); 
              Object.assign(postData, formData);
              return JSON.stringify(postData);
            },
            dataSrc: function (json) {
                // totalSummary 저장
                totalSumm = json.totalSumm || {};
                return json.data;
            },
            // 서버 에러 처리 등 추가 가능
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("DataTables Ajax Error: ", textStatus, errorThrown);
                // 사용자에게 에러 메시지 표시 등
            }
          },
            columns: [               
                { data: 'chain_nm' }
                // , { data: 'biz_no' }
                , { data: 'ceo_nm' }
                , { data: 'tot_use_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                , { data: 'biz_loan_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                , { data: 'spot_loan_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                , { data: 'etc_loan_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') } 
                , { data: 'remain_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') } 
                , { data: 'svc_stat_nm', render: function(data, type, row) {
                  if (type === 'display' && row.svc_stat === 'C') {
                    return '<span style="background-color: red; color: white; padding: 2px 4px; border-radius: 3px;">' + data + '</span>';
                  }
                  return data;
                  }
                }
                , { data: 'remit_stat_nm', render: function(data, type, row) {
                  if (type === 'display' && row.remit_stat === 'N') {
                    return '<span style="background-color: orange; padding: 2px 4px; border-radius: 3px;">' + data + '</span>';
                  }
                  return data;
                  }
                }
                , { data: 'chain_no', visible: false }
              ],
            columnDefs: [
             { targets: 0, width: '160px', className: 'text-left' }
            // , { targets: 1, width: '120px', className: 'text-center' }
            , { targets: 1, width: '70px', className: 'text-center' }
            , { targets: 2, width: '110px', className: 'text-right' }
            , { targets: 3, width: '110px', className: 'text-right' }
            , { targets: 4, width: '100px', className: 'text-right' }
            , { targets: 5, width: '90px', className: 'text-right' }
            , { targets: 6, width: '110px', className: 'text-right' }
            , { targets: 7, width: '50px', className: 'text-center' }
            , { targets: 8, width: '50px', className: 'text-center' }
            // , { targets: 9, width: '50px', className: 'text-center' }
          ],
          order: [[7, 'asc'],[9, 'desc']],
          paging: true,
          lengthChange: false,
          searching: false,
          ordering: true,
          autoWidth: false,
          responsive: true,
          scrollCollapse: false,
          pageLength: 20,
          scrollY: '400px',
          info: false,
          language: {
            emptyTable: '데이터가 없습니다.',
            search: '검색:',
            zeroRecords: '일치하는 데이터가 없습니다.',
            loadingRecords: '로딩중...',
            processing: '처리중...',
          },
          footerCallback: function (row, data, start, end, display) {
                var api = this.api();
                const renderNumber = $.fn.dataTable.render.number(',', '.', 0, '').display;
                const colMap = {
                    2: 'tot_use_amt',
                    3: 'biz_loan_amt',
                    4: 'spot_loan_amt',
                    5: 'etc_loan_amt',
                    6: 'remain_amt',
                };
                Object.entries(colMap).forEach(([colIdx, key]) => {
                    const footer = api.column(Number(colIdx)).footer();
                    if (footer) {
                        const val = totalSumm[key] || 0;
                        $(footer).html(renderNumber(val));
                    }
                }); 
            },
        }); 
        
        $('#sch_chain_nm').on('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); triggerChainSearch(); }});
        $('#btn_chain_find').on('click', function(){ triggerChainSearch(); });

        function triggerChainSearch(){
          var keyword = ($('#sch_chain_nm').val()||'').trim();
          if(!keyword){ alert('가맹점명을 입력하세요.'); return; }
          if(keyword.length<2){ alert('가맹점명은 2자 이상 입력하세요.'); return; }
          $.ajax({ url:'/common/getChainSchList', type:'GET', dataType:'json', data:{ keyword: keyword },
            success:function(list){
              var results = list||[];
              if(results.length===0){ alert('검색 결과가 없습니다.'); $('#sch_chain_no').val(''); return; }
              if(results.length===1){ $('#sch_chain_no').val(results[0].code); $('#sch_chain_nm').val(results[0].codeNm); return; }
              openChainSelectModal(results);
            },
            error:function(){ alert('가맹점 검색 중 오류가 발생했습니다.'); }
          });
        }

        function openChainSelectModal(results){
          var $tbody = $('#tbl_chain_select tbody');
          $tbody.empty();
          results.forEach(function(item){
            var $tr = $('<tr/>')
              .append($('<td/>',{text:item.code, class:'text-center'}))
              .append($('<td/>',{text:item.codeNm}))
              .css('cursor','pointer')
              .on('click', function(){ $('#sch_chain_no').val(item.code); $('#sch_chain_nm').val(item.codeNm); $('#modal_chain_select').modal('hide'); });
            $tbody.append($tr);
          });
          $('#modal_chain_select').modal('show');
        }

        $('#btn_search').click(function () {
          fn_clear_all();
          tbl_loan_summary.ajax.reload();    
          // $('#tbl_chain_loan_list').DataTable().clear().draw();
        });

        function fn_clear_all(){
          //Hidden Values Clear  별도로 처리해야  clear됨
          $('#sch_loan_chain_no').val('');
          $('#frm_chain_list')[0].reset();
          
          $('#sch_loan_no').val('');
          $('#chain_no').val('');
          $('#frm_loan_mst')[0].reset();  

          $('#frm_counsel_mst')[0].reset();
          
          tbl_chain_loan_list.ajax.reload();
          tbl_counsel_list.ajax.reload();
        } 

        $('#sch_all').change(function () {
          $('#btn_search').click();
        });

        $('#sch_chain_all').change(function () {
          $('#btn_search').click();
        });

        $('#tbl_loan_summary').on('click', 'tr', function () {
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            tbl_loan_summary.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
          }
          var data = tbl_loan_summary.row(this).data();
          if (data) {
            $('#frm_chain_list')[0].reset();
            $('#frm_loan_mst')[0].reset();

            $('#sch_cont_sdt').val(data.min_cont_dt);
            $('#sch_cont_edt').val(data.max_cont_dt);
            $('#sch_loan_chain_no').val(data.chain_no); 
            $('#chain_no').val(data.chain_no);
            $('#corp_cd').val(data.corp_cd);
            $('#corp_nm').val(data.corp_nm);
            $('#int_rate').val(data.int_rate);
            $('#delay_rate').val(data.delay_rate);
            tbl_chain_loan_list.ajax.reload();
            tbl_counsel_list.ajax.reload(); // 상담 목록도 초기화
          }
          editMode = 'update';
          fn_frm_loan_mst_clear();
          fn_frm_counsel_reset();
        });

        $('#btn_list_search').click(function () {
          tbl_chain_loan_list.ajax.reload(); 
          fn_frm_loan_mst_clear();
          fn_frm_counsel_reset();
        });

        $('#btn_excel').click(function () {
          var formData = $('#frm_sch_summ_list').serializeObject(); 
          $('#globalLoadingBar').show();  
          $.ajax({
            url: '/loan/loan/loanMng/loanSummaryExcel',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            xhrFields: {
              responseType: 'blob'
            },
            success: function (data, status, xhr) {
              var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              var link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = '대출 현황.xlsx';
              link.click();
            },
            error: function (xhr, status, error) {
              alert('Excel download failed.');
            },
            complete: function () {
              $('#globalLoadingBar').hide();
            }
          });
        }); 

        // --------------------------------------------------------------- frm_chain_list 정보 처리 ---------------------------------------------------
        var tbl_chain_loan_list = $('#tbl_chain_loan_list').DataTable({
            processing: true,
            serverSide: true,
            select: true,
            responsive: true,
            ajax: {
              url: '/loan/loan/loanMng/chainLoanList',
              contentType: 'application/json',
              dataType: 'JSON',
              type: 'POST',
              data: function (postData) {
                formData = $('#frm_chain_list').serializeObject();
                Object.assign(postData, formData);
                return JSON.stringify(postData);
              },
              dataSrc: function (json) {
                  // totalSummary 저장
                  totalSumm = json.totalSumm || {};
                  return json.data;
              },
              // 서버 에러 처리 등 추가 가능
              error: function(jqXHR, textStatus, errorThrown) {
                  console.error("DataTables Ajax Error: ", textStatus, errorThrown);
                  // 사용자에게 에러 메시지 표시 등
              }
            },
              columns: [
                  { 
                    data: 'loan_no',
                    render: function (data, type, row, meta) {
                      return meta.row + 1 + meta.settings._iDisplayStart;
                    }
                  }
                  , { data: 'loan_type_nm' }
                  , { 
                      data: 'loan_sdt',
                      render: function(data, type, row) {
                      // if (row.loan_sdt && row.loan_edt) {
                        return row.loan_sdt + ' ~ ' + row.loan_edt ; // +  ' (' + row.loan_day + '일)';
                      // }
                      // return '';
                      }
                    }                  
                  , { data: 'loan_status_nm' }
                  , { data: 'princ_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                  , { data: 'int_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                  , { data: 'remain_princ_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') }
                  , { data: 'delay_yn' }
                  , { data: 'loan_expr_dt' }
                ],
              columnDefs: [                 
                    { targets: 0, width: '60px', className: 'text-center dt-body-center' } // 중앙 정렬 확인
                  , { targets: 1, width: '120px', className: 'text-left' }
                  , { targets: 2, width: '240px', className: 'text-left' }
                  , { targets: 3, width: '80px', className: 'text-center' }
                  , { targets: 4, width: '120px', className: 'text-right' }
                  , { targets: 5, width: '100px', className: 'text-right' }
                  , { targets: 6, width: '120px', className: 'text-right' }
                  , { targets: 7, width: '80px', className: 'align-middle white-space-nowrap text-center pe-0' }
                  , { targets: 8, width: '100px', className: 'text-center' }

            ],
            order: [[2, 'desc']],
            paging: true,
            lengthChange: false,
            searching: false,
            ordering: true,
            autoWidth: false,
            responsive: true,
            // scrollCollapse: true,
            pageLength: 5,
            scrollY: '180px',
            info: false,
            language: {
              emptyTable: '데이터가 없습니다.',
              search: '검색:',
              zeroRecords: '일치하는 데이터가 없습니다.',
              loadingRecords: '로딩중...',
              processing: '처리중...',
            },
            footerCallback: function (row, data, start, end, display) {
                var api = this.api();
                const renderNumber = $.fn.dataTable.render.number(',', '.', 0, '').display;
                const colMap = {
                    4: 'princ_amt',
                    5: 'int_amt', 
                    6: 'remain_princ_amt', 
                };
                Object.entries(colMap).forEach(([colIdx, key]) => {
                    const footer = api.column(Number(colIdx)).footer();
                    if (footer) {
                        const val = totalSumm[key] || 0;
                        $(footer).html(renderNumber(val));
                    }
                }); 
            },
        });

        $('#tbl_chain_loan_list').on('click', 'tr', function () {
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            tbl_chain_loan_list.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
          }
          var data = tbl_chain_loan_list.row(this).data();
          isListClick = true;
          if (data) {
            $('#frm_loan_mst')[0].reset();
            $('#loan_no').val(data.loan_no);             
            $('#corp_cd').val(data.corp_cd);
            
            $('#corp_nm').val(data.corp_nm);
            $('#chain_no').val(data.chain_no);
            $('#loan_type').val(data.loan_type);

            $('#cont_dt').val(data.cont_dt);
            $('#loan_status').val(data.loan_status); 
            $('#loan_status_nm').val(data.loan_status_nm); 
            $('#princ_amt').val(Number(data.princ_amt).toLocaleString());
            $('#int_amt').val(Number(data.int_amt).toLocaleString());
            $('#tot_loan_amt').val(Number(data.tot_loan_amt).toLocaleString());
            $('#int_rate').val(data.int_rate);
            $('#loan_sdt').val(data.loan_sdt);
            $('#loan_day').val(data.loan_day);
            $('#loan_edt').val(data.loan_edt);

            $('#delay_rate').val(data.delay_rate);
            $('#delay_status').val(data.delay_yn + " / " + data.delay_cnt + "회");
            $('#recv_status').val("납입 : " + data.recv_cnt + " / 잔여 : " + data.unrecv_cnt + " 회");

            $('#loan_memo').val(data.loan_memo);
            $('#upt_dttm').val(data.upt_dttm);
            $('#upt_user_id').val(data.upt_user_id);

            $('#frm_prepay')[0].reset();
            $('#prepay_recv_date').val(toDay); 
            $('#prepay_loan_no').val(data.loan_no); 


            $('#cont_dt').prop('readonly', true).addClass('bg-light');
            $('#princ_amt').prop('readonly', true).addClass('bg-light');
            $('#int_rate').prop('readonly', true).addClass('bg-light');
            $('#loan_sdt').prop('readonly', true).addClass('bg-light');
            $('#loan_edt').prop('readonly', true).addClass('bg-light');
            $('#loan_day').prop('readonly', true).addClass('bg-light');
            $('#loan_type').prop('readonly', true).addClass('bg-light');
            $('#delay_rate').prop('readonly', true).addClass('bg-light');

            // // 금액을 조금이라도 수납하면. 수정 불가 
            // if (data.issue_amt > '0') {
            //   $('#princ_amt').prop('readonly', true);
            // }else{
            //   $('#princ_amt').prop('readonly', false);
            // }

            editMode = 'update';
            if (data.delete_chk == 'Y') {
              $('#btn_delete').show();
            } else {
              $('#btn_delete').hide();
            } 

            if (data.loan_status === '01') {
              $('#btn_prepay_view').show();
            } else {
              $('#btn_prepay_view').hide();
            }
            $('#btn_prepay_create').hide();
            isListClick = false;
          }
        });

        function fn_frm_loan_mst_clear(){
          var corp_cd   = $('#corp_cd').val();          
          var corp_nm   = $('#corp_nm').val();
          var chain_no  = $('#chain_no').val();
          var int_rate  = $('#int_rate').val();
          var delay_rate = $('#delay_rate').val();
          
          $('#frm_loan_mst')[0].reset();
          if(chain_no == ''){
            swal('실패', "가맹점을 먼저 선택해주세요.", 'error');
            return;
          }
          tbl_chain_loan_list.$('tr.selected').removeClass('selected');
          $('#corp_cd').val(corp_cd); 
          $('#loan_status').val("01"); 
          $('#corp_nm').val(corp_nm); 
          $('#chain_no').val(chain_no); 
          $('#int_rate').val(int_rate); 
          $('#delay_rate').val(delay_rate);
          $('#cont_dt').val(toDay);
          $('#loan_sdt').val(toDay); 
          $('#cont_dt').prop('readonly', false).removeClass('bg-light');
          $('#princ_amt').prop('readonly', false).removeClass('bg-light');
          $('#int_rate').prop('readonly', false).removeClass('bg-light');
          $('#loan_sdt').prop('readonly', false).removeClass('bg-light');
          $('#loan_day').prop('readonly', false).removeClass('bg-light');
          $('#loan_type').prop('readonly', false).removeClass('bg-light');
          $('#delay_rate').prop('readonly', false).removeClass('bg-light');

          // editMode = 'create';
          $('#btn_delete').hide();
          $('#btn_prepay_view').hide();
          $('#btn_prepay_create').show();
        }
 

        /**
         * 원리금 균등상환 방식으로 이자액, 총액 계산 (일수 / 금융권 표준 로직)
         */
        function setIntAmtEqualInstallment() {
          var loanType = $('#loan_type').val();
          var principal = parseFloat($('#princ_amt').val().replace(/,/g, '')) || 0;
          var annualRate = parseFloat($('#int_rate').val()) || 0;
          var days = parseInt($('#loan_day').val()) || 0;

          var intAmt = 0;
          var totAmt = 0;

          if (principal > 0 && annualRate > 0 && days > 0) {
            var dailyRate = annualRate / 365 / 100; // 일 이자율
            // 스팟 제외 (L02001이 스팟인가? 기존 코드 기준 그대로 유지)
            if (loanType == 'L02001') {
              // 스팟이면 단순이자 방식
              intAmt = Math.floor(principal * dailyRate * days); // 내림
              totAmt = principal + intAmt;
            } else {
              const result = calcDailyEqualPayment(principal, annualRate, days);
              intAmt = result.totalInterest;
              totAmt = result.totalPayment;
              // console.log("일납입금:", result.dailyPayment);
              // console.log("총이자:", result.totalInterest);
              // console.log("총상환액:", result.totalPayment);             
            }
          }

          $('#int_amt').val(intAmt.toLocaleString());
          $('#tot_loan_amt').val(totAmt.toLocaleString());
        }

        Decimal.set({ precision: 20, rounding: Decimal.ROUND_HALF_UP });

        function calcDailyEqualPayment(principal, annualRatePercent, days) {
          var P = new Decimal(principal);
          var annualRate = new Decimal(annualRatePercent).div(100); // 20 -> 0.20
          var r = annualRate.div(365); // 일이율

          // (1 + r)^n
          var onePlusR = r.plus(1);
          var pow = onePlusR.pow(days);

          // 일납입금 계산 (소수 유지, 마지막에만 반올림)
          // A = P * r * pow / (pow - 1)
          var dailyPaymentCalc = P.mul(r).mul(pow).div(pow.minus(1));
          // console.log("일납입금(소수):", dailyPaymentCalc.toString());  
          // 출력용(원 단위 반올림) — 여기서만 버림 금융권에서는 일납입금을 DOWN 처리하는게 일반적임.
          var dailyPayment = dailyPaymentCalc.toDecimalPlaces(0, Decimal.ROUND_DOWN);

          var remain = P;
          var totalInterest = new Decimal(0);
          var schedule = [];

          for (var i = 1; i <= days; i++) {
            // 이자 = 잔액 * r  -> 반올림 (금융권 표준)
            var interest = remain.mul(r).toDecimalPlaces(0, Decimal.ROUND_DOWN);

            // 원금 = (정수 반올림된) 일납입금 - (반올림된) 이자
            var principalPayment = dailyPayment.minus(interest);

            // 마지막 회차 보정: 잔액을 정확히 0으로 만들기
            if (i === days) {
              // 남은 잔액(정수) 만큼 마지막 원금에 더해서 0으로 만든다.
              // remain은 소수 자릿수 없이 정확하도록 유지됨.
              principalPayment = principalPayment.plus(remain);
            }

            // 잔액 차감 (정수 단위)
            remain = remain.minus(principalPayment);
            // 누적 이자
            totalInterest = totalInterest.plus(interest);
            schedule.push({
              seq: i,
              interest: interest.toNumber(),
              principal: principalPayment.toNumber(),
              payment: (i === days) ? principalPayment.plus(interest).toNumber() : dailyPayment.toNumber(),
              remain: remain.toNumber()              
            });
            // console.log("회차:", i, "이자:", interest.toString(), "원금:", principalPayment.toString(), "납입금:", (i === days) ? principalPayment.plus(interest).toString() : dailyPayment.toString(), "잔액:", remain.toString());                  
          }

          return {
            dailyPaymentCalc: Number(dailyPaymentCalc.toString()), // 소수값(참고용)
            dailyPayment: Number(dailyPayment.toString()),         // 반올림된 일납입금
            totalInterest: Number(totalInterest.toString()),
            totalPayment: Number(P.plus(totalInterest).toString()),
            schedule: schedule
          };
        }


        $('#princ_amt').on('input', function () {
          setIntAmtEqualInstallment();
        });

        $('#int_rate').on('input', function () {
          setIntAmtEqualInstallment();
        });

        $('#loan_day').on('input', function () {
          setIntAmtEqualInstallment();
        });

        $('#princ_amt').on('focus', function () {
          $(this).select();
        });

        $('#loan_day').on('focus', function () {
          $(this).select();
        });

        $('#btn_prepay_create').click(function () {          
          var checked = true;
          if($('#chain_no').val() == '') {
            swal('실패', "가맹점을 먼저 선택해주세요.", 'error');
            checked = false;
            return;
          } 
          var form = $('#frm_loan_mst');
          if (!form[0].checkValidity()) {
            form[0].reportValidity(); // 브라우저가 어떤 항목이 잘못됐는지 보여줌
            checked = false;
            return;
          }

          if (checked) {
            ConfirmdialogToAjax('create', '/loan/loan/loanMng/insertLoanMst', $('#frm_loan_mst').serialize(), fn_return_result);
          }
        }); 

        // loan_type 변경 시 대출종료일 제어
        $('#loan_type').on('change', function () {
          var val = $(this).val();
          var $loanEdt = $('#loan_edt');
          if (val === 'L02001') {
            $loanEdt.prop('readonly', false).removeClass('bg-light');    //.focus();
          } else {
            $loanEdt.prop('readonly', true).addClass('bg-light');
          }
        });

        $('#loan_sdt').on('change', function () {
          setLoanEdt();
        });

        $('#loan_day').on('input change', function () {
          setLoanEdt();
        });

        function setLoanEdt(){
          var loanDay = parseInt($('#loan_day').val(), 10);
          var loanSdt = $('#loan_sdt').val();
          if (!isNaN(loanDay) && loanDay > 0 && loanSdt) {
            var sdt = new Date(loanSdt.replace(/-/g, '/'));
            if (!isNaN(sdt.getTime())) {
              sdt.setDate(sdt.getDate() + loanDay );
              var yyyy = sdt.getFullYear();
              var mm = ('0' + (sdt.getMonth() + 1)).slice(-2);
              var dd = ('0' + sdt.getDate()).slice(-2);
              $('#loan_edt').val(yyyy + '-' + mm + '-' + dd);
            } else {
              $('#loan_edt').val('');
            }
          } else {
            $('#loan_edt').val('');
          }
        }

        $('#loan_edt').on('change', function () {
          var loanSdt = $('#loan_sdt').val();
          var loanEdt = formatYmdToHyphen($('#loan_edt').val());

          if (loanSdt && loanEdt) {
            var sdt = new Date(loanSdt.replace(/-/g, '/'));
            var edt = new Date(loanEdt.replace(/-/g, '/'));
            if (edt < sdt) {
              alert('종료일은 시작일보다 빠를 수 없습니다.');
              $('#loan_day').val('');
              return;
            }

            if (!isNaN(sdt.getTime()) && !isNaN(edt.getTime())) {
              var diff = Math.floor((edt - sdt) / (1000 * 60 * 60 * 24)) ; 
              $('#loan_day').val(diff > 0 ? diff : 0);
            } else {
              $('#loan_day').val('');
            }
          } else {
            $('#loan_day').val('');
          }
        });

        function formatYmdToHyphen(ymd) {
          if (!/^\d{8}$/.test(ymd)) return ''; // 유효성 검사

          var year = ymd.substring(0, 4);
          var month = ymd.substring(4, 6);
          var day = ymd.substring(6, 8);

          return `${year}-${month}-${day}`;
        }


        $('#btn_delete').click(function () {
          var selectData = tbl_chain_loan_list.row('.selected').data();
          if (selectData) {
            if(Number(selectData.recv_amt) > 0) {
              swal('실패', "수납 기록이 있습니다. 수납 기록이 있는 경우 삭제 할 수 없습니다.", 'error');
              return;
            }
            if(Number(selectData.trans_cnt) > 0) {
              swal('실패', "차감 전송 건은 삭제 할 수 없습니다.", 'error');
              return;
            }
            var loan_no = $('#loan_no').val();
            if(loan_no == '') {
              swal('실패', "대출건을 먼저 선택해주세요.", 'error');
              return;
            }
            $('#crud').val('delete');
            ConfirmdialogToAjax('delete', '/loan/loan/loanMng/deleteLoanMst', $('#frm_loan_mst').serialize(), fn_return_result); 
          } else {
            swal('실패', "대출건을 먼저 선택해주세요.", 'error'); 
            return;
          } 
        });

        $('#btn_prepay_view').click(function () {          
          
          var selectData = tbl_chain_loan_list.row('.selected').data();
                    
          if (!selectData) {
            swal('실패', "대출건을 먼저 선택해주세요.", 'error');
            return;
          }
          $('#prepay_recv_date').val(toDay);
          $('#prepay_loan_no').val(selectData.loan_no);            
          $('#pre_princ_amt').val(Number(selectData.remain_princ_amt).toLocaleString());  
          $('#pre_int_amt').val(Number(selectData.pre_int_amt).toLocaleString());
          $('#post_princ_amt').val(Number(selectData.post_princ_amt).toLocaleString());
          $('#delay_int_amt').val(Number(selectData.delay_int_amt).toLocaleString());
          $('#prepay_tot_amt').val(Number(selectData.prepay_tot_amt).toLocaleString());

          $('#modal_prepay').modal('show'); // Show the modal
        });

        $('#btn_prepay').click(function () {                      
          var loan_no = $('#prepay_loan_no').val();
          if(loan_no == '') {
            swal('실패', "대출건을 먼저 선택해주세요.", 'error');
            return;
          }
          var formData = {
              prepay_recv_date : $('#prepay_recv_date').val()
            , prepay_memo     : $('#prepay_memo').val()
            , prepay_loan_no  : $('#prepay_loan_no').val()
          }

          ConfirmdialogToAjax('execute', '/loan/loan/loanMng/procLoanPrepay', formData, fn_prepay_result); 
        
        });

        function fn_prepay_result(data) {
          var resultCode = data.resultCode;
          var resultMsg = data.resultMsg;

          if (resultCode == 'S000') {
            $('#modal_prepay').modal('hide');
            swal('성공', '작업을 정상적으로 완료하였습니다.', 'success');            
            
            if (editMode === 'update') {
              // 수정 모드일 때는 선택된 행을 유지
              var selectedRowData = tbl_loan_summary.row('.selected').data();
            } else {
              // 생성 모드일 때는 선택된 행이 없음
              var selectedRowData = null;
            } 
            tbl_loan_summary.ajax.reload(function() {
              // 리로드 완료 후 이전에 선택되었던 행을 다시 선택
              if (selectedRowData) {
                tbl_loan_summary.rows().every(function() {
                  if (this.data().chain_no === selectedRowData.chain_no) {
                    $(this.node()).click();
                    return false; // 찾으면 루프 중단
                  }
                });
              }
            }, false);            
            tbl_chain_loan_list.ajax.reload(null, false); // 현재 페이지 유지

            fn_frm_loan_mst_clear();
          } else { 
            swal('실패', resultMsg, 'error');
          }
        } 

        function fn_return_result(data) {
          var resultCode = data.resultCode;
          var resultMsg = data.resultMsg;

          if (resultCode == 'S000') {
            swal('성공', '작업을 정상적으로 완료하였습니다.', 'success');             
            // 현재 선택된 행의 데이터 저장
            if (editMode === 'update') {
              // 수정 모드일 때는 선택된 행을 유지
              var selectedRowData = tbl_loan_summary.row('.selected').data();
            } else {
              // 생성 모드일 때는 선택된 행이 없음
              var selectedRowData = null;
            } 
            tbl_loan_summary.ajax.reload(function() {
              // 리로드 완료 후 이전에 선택되었던 행을 다시 선택
              if (selectedRowData) {
                tbl_loan_summary.rows().every(function() {
                  if (this.data().chain_no === selectedRowData.chain_no) {
                      $(this.node()).click();
                      return false; // 찾으면 루프 중단
                  }
                });
              }
            }, false);
            $('#sch_cont_edt').val($('#cont_dt').val()); // 계약일을 검색조건으로 설정
            tbl_chain_loan_list.ajax.reload(null, false); // 현재 페이지 유지
            fn_frm_loan_mst_clear();
          } else { 
            swal('실패', resultMsg, 'error');
          }
        } 

        $('#btn_clear').click(function () {
          fn_frm_loan_mst_clear();
        });

        $('#btn_counsel').click(function () {
          if ($('#chain_no').val() == "" )  {
            swal('확인', "가맹점을 선택 하세요", 'error');
            return ;
          }
          $('#modal_counsel').modal('show'); // Show the modal
        });

        $('#btn_schedule').click(function () {
          var selectData = tbl_chain_loan_list.row('.selected').data();
          if (selectData) { 
            if (selectData.loan_no == ""){
              swal("확인", "대출 건을 선택해 주세요.", 'error');
              return;
            }
            $('#loan_no').val(selectData.loan_no);

          } else {
            if ($('#princ_amt').val() == "0" || $('#princ_amt').val() == "")  {
              swal('확인', "대출원금을 입력하세요", 'error');
              return ;
            }
            if ($('#int_rate').val() == "0" || $('#int_rate').val() == "") {
              swal('확인', "이자율을 입력하세요", 'error');
              return ;
            }
            if ($('#loan_sdt').val() == "" || $('#loan_sdt').val() == "") {
              swal('확인', "대출 시작일을 입력하세요", 'error');
              return ;
            }
            if ($('#loan_day').val() == "0" || $('#loan_day').val() == "") {
              swal('확인', "대출 일 수 를 입력하세요", 'error');
              return ;
            } 
          }
          $('#modal_schedule').modal('show'); // Show the modal
        });

        var tbl_counsel_list = $('#tbl_counsel_list').DataTable({
          processing: true,
          serverSide: true,
          select: true,
          responsive: true,
          ajax: {
            url: '/base/organ/chainMng/counselList',
            contentType: 'application/json',
            dataType: 'JSON',
            type: 'POST',
            data: function (postData) {

              var formData = {
              sch_chain_no : $('#chain_no').val()
              , sch_chain_tp : 'LOAN'
              , sch_counsel_sdt : $('#sch_counsel_sdt').val()
              , sch_counsel_edt : $('#sch_counsel_edt').val()
              };
              Object.assign(postData, formData);
              return JSON.stringify(postData);
            },
          },
          columns: [
            { data: 'counsel_dt' },
            { data: 'counsel_cd_nm' },
            { data: 'counsel_cust_nm' },
            { data: 'counsel_conts',
                    render: function(data, type, row) {
                      if (data && data.length > 30) {
                        return data.substring(0, 30) + '...';
                      }
                      return data;
                    } 
            },
          ],
          columnDefs: [
            { targets: 0, width: '100px', className: 'text-center' },
            { targets: 1, width: '150px', className: 'text-center' },
            { targets: 2, width: '120px', className: 'text-center' },
            { targets: 3, width: '300px', className: 'text-left' },
          ],
          order: [[0, 'desc']],
          paging: true,
          lengthChange: false,
          searching: false,
          ordering: true,
          autoWidth: false,
          responsive: true,
          scrollCollapse: false,
          pageLength: 5, 
          scrollY: '150px',
          info: false,
          language: {
            emptyTable: '데이터가 없습니다.',
            zeroRecords: '일치하는 데이터가 없습니다.',
            loadingRecords: '로딩중...',
            processing: '처리중...',
          },
        }); 

        $('#tbl_counsel_list').on('click', 'tr', function () {
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            $('#tbl_counsel_list').DataTable().$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
          }
          var data = $('#tbl_counsel_list').DataTable().row(this).data();
          if (data) {
            $('#counsel_no').val(data.counsel_no);
            $('#counsel_dt').val(data.counsel_dt);
            $('#counsel_cd').val(data.counsel_cd);
            $('#counsel_cust_nm').val(data.counsel_cust_nm);
            $('#counsel_conts').val(data.counsel_conts); 
 
            $('#btn_counsel_delete').show();
            $('#btn_counsel_update').show();
            $('#btn_counsel_create').hide();
          }
        });

        $('#btn_counsel_clear').click(function () {
          fn_frm_counsel_reset();
        });

        $('#btn_counsel_delete').click(function () {
          var counsel_no = $('#counsel_no').val();
          if (counsel_no) {
            var formData = {
              counsel_no : $('#counsel_no').val()
              , chain_no : $('#chain_no').val()
              , counsel_tp : 'LOAN'
              , counsel_cd : $('#counsel_cd').val()
              , counsel_dt : $('#counsel_dt').val()
              , counsel_cust_nm : $('#counsel_cust_nm').val()
              , counsel_conts : $('#counsel_conts').val()
            };
            ConfirmdialogToAjax('delete', '/base/organ/chainMng/deleteCounsel', formData, fn_return_counsel_result); 
          } else {
            swal('실패', "상담건을 먼저 선택해주세요.", 'error'); 
            return;
          } 
        });

        $('#btn_counsel_update').click(function () {
          var form = $('#frm_counsel_mst');
          var checked = true;
          if (!form[0].checkValidity()) {
            form[0].reportValidity(); // 브라우저가 어떤 항목이 잘못됐는지 보여줌
            checked = false;
            return;
          }

          if (checked) { 
            var formData = {
              counsel_no : $('#counsel_no').val()
              , chain_no : $('#chain_no').val()
              , counsel_tp : 'LOAN'
              , counsel_cd : $('#counsel_cd').val()
              , counsel_dt : $('#counsel_dt').val()
              , counsel_cust_nm : $('#counsel_cust_nm').val()
              , counsel_conts : $('#counsel_conts').val()
            };
            ConfirmdialogToAjax('update', '/base/organ/chainMng/updateCounsel', formData, fn_return_counsel_result); 
          } 
        });

        $('#btn_counsel_create').click(function () {
          var form = $('#frm_counsel_mst');
          var checked = true;
          if (!form[0].checkValidity()) {
            form[0].reportValidity(); // 브라우저가 어떤 항목이 잘못됐는지 보여줌
            checked = false;
            return;
          }

          if (checked) { 
            var formData = {
              chain_no : $('#chain_no').val()
              , counsel_tp : 'LOAN'
              , counsel_cd : $('#counsel_cd').val()
              , counsel_dt : $('#counsel_dt').val()
              , counsel_cust_nm : $('#counsel_cust_nm').val()
              , counsel_conts : $('#counsel_conts').val()
            };
            ConfirmdialogToAjax('create', '/base/organ/chainMng/insertCounsel', formData, fn_return_counsel_result); 
          }
        });

        function fn_return_counsel_result(data) {
          var resultCode = data.resultCode;
          var resultMsg = data.resultMsg;
          if (resultCode == 'S000') {
            swal('성공', '작업을 정상적으로 완료하였습니다.', 'success');            

            // 현재 선택된 행의 데이터 저장
            if (editMode === 'update') {
              // 수정 모드일 때는 선택된 행을 유지
              var selectedRowData = tbl_loan_summary.row('.selected').data();
            } else {
              // 생성 모드일 때는 선택된 행이 없음
              var selectedRowData = null;
            } 
            tbl_counsel_list.ajax.reload(function() {
              // 리로드 완료 후 이전에 선택되었던 행을 다시 선택
              if (selectedRowData) {
                tbl_counsel_list.rows().every(function() {
                  if (this.data().counsel_no === selectedRowData.counsel_no) {
                    $(this.node()).click();
                    return false; // 찾으면 루프 중단
                  }
                });
              }
            }, false);

             
            fn_frm_counsel_reset();
          } else { 
            swal('실패', resultMsg, 'error');
          }
        }

        function fn_frm_counsel_reset() { 
          $('#frm_counsel_mst')[0].reset(); 
          $('#btn_counsel_delete').hide();
          $('#btn_counsel_update').hide();
          $('#btn_counsel_create').show(); 
        }


        // 모달 창 표시될때 초기화 처리
        $('#modal_schedule').on('shown.bs.modal', function() {
          // 모달 열릴 때 첫 번째 포커스 가능 요소로 이동
          $(this).data('trigger-element', document.activeElement);
          if ($.fn.DataTable.isDataTable('#tbl_modal_schedule')) {
            $('#tbl_modal_schedule').DataTable().destroy();
          }

          var tbl_modal_schedule = $('#tbl_modal_schedule').DataTable({
            processing: true,
            serverSide: true,
            select: true,
            responsive: true,
            ajax: {
              url: '/loan/loan/loanMng/viewRepaySchdule',
              contentType: 'application/json',
              dataType: 'JSON',
              type: 'POST',
              data: function (postData) {
                // formData = $('#frm_modal_schedule').serializeObject();
                var formData = {
                loan_no : $('#loan_no').val()
                , loan_type : $('#loan_type').val()
                , princ_amt : $('#princ_amt').val()
                , int_rate : $('#int_rate').val()
                , loan_day : $('#loan_day').val()
                , loan_sdt : $('#loan_sdt').val()
                };
                Object.assign(postData, formData);
                return JSON.stringify(postData);
              },
              },
            columns: [
              { data: 'sc_seq' },
              { data: 'sc_date' },
              { data: 'balance_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
              { data: 'repay_princ_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
              { data: 'repay_int_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
              { data: 'repay_tot_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },

              { 
                data: 'remain_princ_amt', 
                render: function(data, type, row) {
                  if (row.recv_yn === 'D') {
                    return '<span style="color:red;font-weight:bold;">' + $.fn.dataTable.render.number(',', '.', 0, '').display(data) + '</span>';
                  }
                  return $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                }
              },
              { 
                data: 'remain_int_amt', 
                render: function(data, type, row) {
                  if (row.recv_yn === 'D') {
                    return '<span style="color:red;font-weight:bold;">' + $.fn.dataTable.render.number(',', '.', 0, '').display(data) + '</span>';
                  }
                  return $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                }
              },
              { 
                data: 'remain_tot_amt', 
                render: function(data, type, row) {
                  if (row.recv_yn === 'D') {
                    return '<span style="color:red;font-weight:bold;">' + $.fn.dataTable.render.number(',', '.', 0, '').display(data) + '</span>';
                  }
                  return $.fn.dataTable.render.number(',', '.', 0, '').display(data);
                }
              },
              { data: 'recv_dt' },
              {
                data: 'recv_yn_nm', 
                render: function(data, type, row) {
                  const today = new Date();
                  const scDate = new Date(row.sc_date);

                  if (scDate <= today && row.sub_trans_yn === 'N') {
                    return data + '&nbsp;&nbsp;<button type="button" class="btn btn-warning btn-sm btn-subtrans" data-sc-seq="' + row.sc_seq + '">차감</button>';
                  }
                  return data;
                }
              },
            ],
            columnDefs: [
              { targets: 0, width: '50px', className: 'text-center' },
              { targets: 1, width: '90px', className: 'text-center' },
              { targets: 2, width: '100px', className: 'text-end' },
              { targets: 3, width: '100px', className: 'text-end' },
              { targets: 4, width: '90px', className: 'text-end' },
              { targets: 5, width: '100px', className: 'text-end' },
              { targets: 6, width: '100px', className: 'text-end' },
              { targets: 7, width: '90px', className: 'text-end' },
              { targets: 8, width: '100px', className: 'text-end' },
              { targets: 9, width: '90px', className: 'text-center' },
              { targets: 10, width: '120px', className: 'text-center' },
            ],
            order: [[0, 'asc']],
            paging: false,
            lengthChange: false,
            searching: false,
            ordering: true,
            autoWidth: false,
            responsive: true,
            scrollCollapse: true,
            // pageLength: 10,
            scrollY: '320px',
            info: false,
            language: {
              emptyTable: '데이터가 없습니다.',
              zeroRecords: '일치하는 데이터가 없습니다.',
              loadingRecords: '로딩중...',
              processing: '처리중...',
            },
            footerCallback: function (row, data, start, end, display) {
              var api = this.api();
              // 2~8열: balance_amt, repay_princ_amt, repay_int_amt, repay_tot_amt, remain_princ_amt, remain_int_amt, remain_tot_amt
              var colIndexes = [3,4,5,6,7,8];
              colIndexes.forEach(function(colIdx) {
              var total = api
                .column(colIdx)
                .data()
                .reduce(function(a, b) {
                var x = typeof a === 'string' ? a.replace(/[\$,]/g, '') : a;
                var y = typeof b === 'string' ? b.replace(/[\$,]/g, '') : b;
                return (parseFloat(x) || 0) + (parseFloat(y) || 0);
                }, 0);
                // 숫자 포맷
                $(api.column(colIdx).footer()).html($.fn.dataTable.render.number(',', '.', 0, '').display(total));
                console.log('Footer total for column ' + colIdx + ': ' + total);
                if(colIdx === 4) {// int_amt
                  $('#int_amt').val($.fn.dataTable.render.number(',', '.', 0, '').display(total));
                } else if(colIdx === 5) {
                  $('#tot_loan_amt').val($.fn.dataTable.render.number(',', '.', 0, '').display(total));   
                }               
              });
            } 
          });
          $('#tbl_modal_recv_log').DataTable().ajax.reload();
          // 첫 번째 포커스 가능 요소로 이동
          $(this).find('button:not([disabled]), input:not([disabled])').first().focus();
          // document.querySelector('body > :not(#modal_schedule)').inert = true;
        });

        $(document).on('click', '.btn-subtrans', function() {
          const sc_seq = $(this).data('sc-seq');
          fn_send_sub_trans(sc_seq);
        });

        function fn_send_sub_trans(sc_seq) {
          if ($('#loan_no').val() == '') {
            swal('실패', "대출건을 먼저 선택해주세요.", 'error');
            return;
          }
          if(!sc_seq) {
            swal('실패', "차감 전송할 상환 스케줄을 선택해주세요.", 'error');
            return;
          }
          var formData = {
              loan_no : $('#loan_no').val()
              , sc_seq : sc_seq
          };          
          ConfirmdialogToAjax('execute', '/loan/loan/loanMng/sendSubTrans', formData, fn_sub_trans_result); 
        }

        function fn_sub_trans_result(data) {
          var resultCode = data.resultCode;
          var resultMsg = data.resultMsg;

          if (resultCode == 'S000') {
            swal('성공', '차감 전송을 정상적으로 완료하였습니다.', 'success');            
            $('#tbl_modal_schedule').DataTable().ajax.reload(); 
          } else { 
            swal('실패', resultMsg, 'error');
          }
        }

        // tbl_modal_schedule row click event
        $('#tbl_modal_schedule').on('click', 'tr', function () {
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            $('#tbl_modal_schedule').DataTable().$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
          } 
          // 수납 내역 테이블 갱신
          $('#tbl_modal_recv_log').DataTable().ajax.reload();
        });

        // 모달이 닫힐 때 포커스 복원
        $('#modal_schedule').on('hidden.bs.modal', function() {
          var triggerElement = $(this).data('trigger-element');
          if (triggerElement) {
            $(triggerElement).focus();
          } 
          document.querySelector('body > :not(#modal_schedule)').inert = false;
          return true; // 모달 닫기 허용
        }); 

        $('#btn_schedule_excel').click(function () {
          var formData = {
              loan_no : $('#loan_no').val()
              , loan_type : $('#loan_type').val()
              , princ_amt : $('#princ_amt').val()
              , int_rate : $('#int_rate').val()
              , loan_day : $('#loan_day').val()
              , loan_sdt : $('#loan_sdt').val()
            };
          $('#globalLoadingBar').show();  
          $.ajax({
            url: '/loan/loan/loanMng/excelRepaySchdule',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            xhrFields: {
              responseType: 'blob'
            },
            success: function (data, status, xhr) {
              var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              var link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = '대출 상환 현황.xlsx';
              link.click();
            },
            error: function (xhr, status, error) {
              alert('Excel download failed.');
            },
            complete: function () {
              $('#globalLoadingBar').hide();
            }
          });
        }); 

        var tbl_modal_recv_log = $('#tbl_modal_recv_log').DataTable({
          processing: true,
          serverSide: true,
          select: true,
          responsive: true,
          ajax: {
            url: '/loan/loan/loanMng/loanRecvLog',
            contentType: 'application/json',
            dataType: 'JSON',
            type: 'POST',
            data: function (postData) {

              var formData = {
              sch_loan_no : $('#loan_no').val()
              , sch_sc_seq : $('#tbl_modal_schedule').DataTable().row('.selected').data() ? $('#tbl_modal_schedule').DataTable().row('.selected').data().sc_seq : ''              
              };
              Object.assign(postData, formData);
              return JSON.stringify(postData);
            },
            dataSrc: function (json) {
                // totalSummary 저장
                totalSumm = json.totalSumm || {};
                return json.data;
            },
            // 서버 에러 처리 등 추가 가능
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("DataTables Ajax Error: ", textStatus, errorThrown);
                // 사용자에게 에러 메시지 표시 등
            }
          },
          columns: [
            { data: 'loan_recv_seq'  
              , render: function (data, type, row, meta) {
                return meta.row + 1 + meta.settings._iDisplayStart;
              }
            },
            { data: 'recv_dt' },            
            { data: 'recv_type_nm' },
            { data: 'recv_princ_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'recv_int_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'recv_amt', render: $.fn.dataTable.render.number(',', '.', 0, '') },
            { data: 'sub_code_nm' },
          ],
          columnDefs: [
            { targets: 0, width: '50px', className: 'text-center' },
            { targets: 1, width: '100px', className: 'text-center' },
            { targets: 2, width: '120px', className: 'text-center' },
            { targets: 3, width: '120px', className: 'text-right' },
            { targets: 4, width: '120px', className: 'text-right' },
            { targets: 5, width: '120px', className: 'text-right' }, 
            { targets: 6, width: '200px', className: 'text-left' }, 
          ],
          order: [[0, 'desc']],
          paging: false,
          lengthChange: false,
          searching: false,
          ordering: true,
          autoWidth: false,
          responsive: true,
          scrollCollapse: false,
          // pageLength: 5, 
          scrollY: '100px',
          info: false,
          language: {
            emptyTable: '데이터가 없습니다.',
            zeroRecords: '일치하는 데이터가 없습니다.',
            loadingRecords: '로딩중...',
            processing: '처리중...',
          },
          footerCallback: function (row, data, start, end, display) {
                var api = this.api();
                const renderNumber = $.fn.dataTable.render.number(',', '.', 0, '').display;
                const colMap = {
                    3: 'recv_princ_amt',
                    4: 'recv_int_amt', 
                    5: 'recv_tot_amt', 
                };
                Object.entries(colMap).forEach(([colIdx, key]) => {
                    const footer = api.column(Number(colIdx)).footer();
                    if (footer) {
                        const val = totalSumm[key] || 0;
                        $(footer).html(renderNumber(val));
                    }
                }); 
            },
        }); 

        $('#tbl_modal_recv_log').on('click', 'tr', function () {
          if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
          } else {
            $('#tbl_modal_recv_log').DataTable().$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
          } 
        });

      });
    </script>
  </head>
  <div class="content">
    <div class="row g-1 mb-1">
      <div class="col-lg-6">
        <div class="card" style="height: 710px;">
          <div class="card-header">
            <div class="row flex-between-end">
              <div class="col-auto align-self-center">
                <h5 class="mb-0">여신 관리</h5>
              </div>
              <div class="col-lg-10">
                <form id="frm_sch_summ_list" name="frm_sch_summ_list" onsubmit="return false;" novalidate="">
                  <div class="row mb-1">
                    <div class="col-sm-5">
                      <div class="input-group input-group-sm mb-1">                        
                        <select class="form-select form-control-sm" id="sch_corp_cd" name="sch_corp_cd">
                          <option value="">선택</option> 
                        </select>
                         <select class="form-select form-control-sm me-1" id="sch_agency_cd" name="sch_agency_cd">
                          <option value="">대리점</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-sm-7">
                      <div class="input-group input-group-sm mb-1">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="sch_all" name="sch_all" value="Y" />
                          <label class="form-check-label" for="sch_all">완납</label>
                        </div> 
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="sch_chain_all" name="sch_chain_all" value="Y" />
                          <label class="form-check-label" for="sch_chain_all">해지</label>
                        </div> 
                      <!-- </div>
                    </div>
                    <div class="col-sm-4">
                      <div class="input-group input-group-sm mb-1"> -->
                        <input type="hidden" id="sch_chain_no" name="sch_chain_no" />
                        <input class="form-control form-control-sm me-1" id="sch_chain_nm" name="sch_chain_nm" placeholder="가맹점명" autocomplete="off" />
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="btn_chain_find" name="btn_chain_find">검색</button>
                        <button type="button" class="btn btn-primary btn-sm" id="btn_search" name="btn_search">조회</button>
                      </div>
                    </div> 
                  </div>
                  <div class="row mb-0">                    
                    <div class="col-sm-12 text-end">
                      <span class="input-group-btn"><button type="button" class="btn btn-success btn-sm" id="btn_excel" name="btn_excel">엑셀</button></span> 
                    </div>                    
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="card-body pt-0 px-0" style="padding-top: 0px">
            <div class="table-responsive scrollbar">
              <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_loan_summary">
                <thead>
                  <tr>
                    <th rowspan="2" class="text-center">가맹점명</th>
                    <!-- <th rowspan="2" class="text-center">사업자번호</th> -->
                    <th rowspan="2" class="text-center">대표자</th>
                    <th rowspan="2" class="text-center">즉결잔고</th>
                    <th colspan="3" class="text-center">대출</th>
                    <th rowspan="2" class="text-center">대출잔액</th>
                    <th rowspan="2" class="text-center">계약</th>
                    <th rowspan="2" class="text-center">출금</th>
                  </tr>
                  <tr>
                    <th class="text-center">비즈론</th>
                    <th class="text-center">스팟</th>
                    <th class="text-center">기타</th>
                  </tr>
                </thead>
                <tbody class="list"></tbody>
                <tfoot>
                  <tr>
                    <th colspan="2" class="text-center">총계</th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th>
                    <th colspan="2" class="text-center">-</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card" style="height: 710px;">
          <div class="card-header">
            <div class="row flex-between-end">
              <!-- <div class="col-auto align-self-center">
                <h5 class="mb-0">대출 상세</h5>
              </div> -->
              <div class="col-sm-12">
                <form id="frm_chain_list" name="frm_chain_list" onsubmit="return false;" novalidate="">
                <div class="row mb-1">
                  <div class="col-sm-6">
                    <div class="input-group">
                      <div class="input-group input-group-sm mb-1 me-1">
                        <label class="col-sm-2 col-form-label col-form-label-sm" for="sch_cont_sdt">발생일</label>
                        <input class="form-control form-control-sm" id="sch_loan_chain_no" type="hidden" name="sch_loan_chain_no" readonly="readonly"/>
                        <div class="col-sm-5">
                          <input class="form-control form-control-sm " id="sch_cont_sdt" type="text" name="sch_cont_sdt" istyle="date" maxlength="10" required />
                        </div>
                        <!-- <span class="input-group-text">~</span> -->
                        <div class="col-sm-5">
                          <input class="form-control form-control-sm" id="sch_cont_edt" type="text" name="sch_cont_edt" istyle="date" maxlength="10" required />
                        </div>
                      </div>
                    </div> 
                  </div>
                  <div class="col-sm-6">
                    <div class="input-group input-group-sm px-3">
                      <select class="form-select form-control-sm" id="sch_loan_type" name="sch_loan_type" style="width: 120px">
                        <option value="">선 택</option>
                      </select>
                      <select class="form-select form-control-sm" id="sch_loan_status" name="sch_loan_status" style="width: 100px">
                        <option value="">선택</option> 
                      </select>
                      <span class="input-group-btn"><button type="button" class="btn btn-primary btn-sm" id="btn_list_search" name="btn_list_search">조회</button></span> 
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="card-body pt-0 px-0" style="padding-top: 0px">
            <div class="table-responsive scrollbar">
              <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_chain_loan_list">
                <thead class="bg-200">
                  <tr>
                    <th class="text-center" style="width: 60px;">No</th>
                    <th class="text-center" style="width: 120px;">대출구분</th>
                    <th class="text-center" style="width: 240px;">대출기간</th> 
                    <th class="text-center" style="width: 80px;">상태</th>
                    <th class="text-center" style="width: 120px;">원금</th>
                    <th class="text-center" style="width: 120px;">이자</th>
                    <th class="text-center" style="width: 120px;">잔액</th>
                    <th class="text-center" style="width: 80px;">연체</th>                    
                    <th class="text-center" style="width: 100px;">종료일</th>
                  </tr>
                </thead>
                <tbody class="list"></tbody>
                <tfoot>
                  <tr>
                    <th colspan="4" class="text-center">총계</th>
                    <th class="text-right px-2"></th>
                    <th class="text-right px-2"></th> 
                    <th class="text-right px-2"></th> 
                    <th colspan="2" class="text-center"></th>
                  </tr>
                </tfoot>
              </table>
            </div> 
            <div class="row flex-between-end">
              <div class="d-flex justify-content-between align-items-center mt-3 mb-3 fw-bold fs-8 border-bottom pb-1 text-primary">
                <span>상세정보</span>
                <div class="col-sm-2">
                  <button type="button" class="btn btn-success btn-sm" id="btn_schedule"><i class="fa fa-check"></i>상환일정</button>
                </div>
                <div class="col-sm-2">
                  <button type="button" class="btn btn-primary btn-sm" id="btn_prepay_view" style="display: none"><i class="fa fa-check"></i>중도 상환</button> 
                </div>
                <div class="col-sm-4 text-end">
                    <!-- <button type="button" class="btn btn-info text-end" id="btn_counsel"><i class="fa fa-check"></i>상담 관리</button> -->
                    <button type="button" class="btn btn-info btn-sm" id="btn_clear"><i class="fa fa-check"></i>신규</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btn_delete" style="display: none"><i class="fa fa-delete"></i>삭제</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btn_prepay_create"><i class="fa fa-save"></i>저장</button>
                </div>
              </div>
              <form class="needs-validation" id="frm_loan_mst" name="frm_loan_mst" onsubmit="return false;" method="post" novalidate=""> 
                <div class="row mb-1">
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_no">관리번호</label> 
                      <input class="form-control form-control-sm" id="chain_no" type="hidden" name="chain_no" readonly="readonly"/>
                      <input class="form-control form-control-sm bg-light" id="loan_no" type="text" name="loan_no" readonly="readonly"/>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="corp_cd">여신사</label>
                      <input id="corp_cd" type="hidden" name="corp_cd" />
                      <input class="form-control form-control-sm bg-light" id="corp_nm" type="text" name="corp_nm" readonly="readonly"/>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="cont_dt">계약일</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm " id="cont_dt" type="text" name="cont_dt" istyle="date" maxlength="10" required />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_type">대출구분</label> 
                      <select class="form-select form-control-sm" id="loan_type" name="loan_type" style="width: 120px" required>
                        <option value="">선택</option> 
                      </select>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="princ_amt">대출원금</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm text-end " id="princ_amt" type="text" name="princ_amt" istyle="amount" value="0" maxlength="15" >
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="int_rate">이자율</label> 
                      <div class="col-sm-8">
                        <div class="input-group">
                          <input class="form-control form-control-sm text-end" id="int_rate" type="text" name="int_rate" placeholder="00.0" istyle="float" maxlength="4" required />
                          <span class="input-group-text">%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_sdt">대출시작일</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm " id="loan_sdt" type="text" name="loan_sdt" istyle="date" maxlength="10" required />
                      </div> 
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_day">대출일 수</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm text-end " id="loan_day" type="text" name="loan_day" istyle="number" value="0" maxlength="5" >
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_edt">대출종료일</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm bg-light" id="loan_edt" type="text" name="loan_edt"  istyle="date" maxlength="10" required  />
                      </div> 
                    </div>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="int_amt">이자액</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm text-end bg-light" id="int_amt" type="text" name="int_amt" istyle="amount" maxlength="10" readonly />
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="tot_loan_amt">총 액</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm text-end bg-light" id="tot_loan_amt" type="text" name="tot_loan_amt" istyle="amount" readonly>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="loan_status">진행상태</label> 
                      <input class="form-control form-control-sm" id="loan_status" type="hidden" name="loan_status"  readonly="readonly"/>
                      <input class="form-control form-control-sm bg-light" id="loan_status_nm" type="text" name="loan_status_nm" value="거래중" readonly="readonly"/>
                    </div>
                  </div>
                </div>
                <div class="row mb-1">
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="delay_rate">연체 이자율</label> 
                      <div class="col-sm-8">
                        <div class="input-group">
                          <input class="form-control form-control-sm text-end" id="delay_rate" type="text" name="delay_rate" placeholder="00.0" istyle="float" maxlength="4" required />
                          <span class="input-group-text">%</span>
                        </div>
                      </div> 
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="delay_cnt">납입상태</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm bg-light" id="recv_status" type="text" name="recv_status" istyle="number" readonly>                        </div>
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-4 col-form-label col-form-label-sm" for="delay_status">연체상태</label> 
                      <div class="col-sm-8">
                        <input class="form-control form-control-sm bg-light" id="delay_status" type="text" name="delay_status" readonly />
                      </div> 
                    </div>
                  </div>                  
                </div>
                <div class="row mb-1">
                  <div class="col-sm-8">
                    <div class="input-group input-group-sm mb-1">
                      <label class="col-sm-2 col-form-label col-form-label-sm" for="loan_memo">비고</label> 
                      <input class="form-control form-control-sm" id="loan_memo" type="text" name="loan_memo" maxlength="50" />
                    </div>
                  </div>
                  <div class="col-sm-4">
                    <div class="input-group input-group-sm mb-1">
                      <input type="text" class="form-control form-control-sm" id="upt_user_id" name="upt_user_id" readonly="readonly" disabled />
                      <input type="text" class="form-control form-control-sm" id="upt_dttm" name="upt_dttm" readonly="readonly" disabled /> 
                    </div>
                  </div>
                </div> 
              </form>
            </div>
          </div>
        </div>
      </div> 
    </div>
    <div class="row g-1 mb-1">
      <div class="col-lg-6">
        <div class="card" style="height: 300px;"> 
          <div class="card-body"> 
            <div class="row g-0 mb-0"> 
              <div class="col-lg-12">
                <div class="table-responsive scrollbar">
                  <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_counsel_list">
                    <thead class="bg-200">
                      <tr>
                        <th class="text-center" style="width: 100px;">상담일</th>
                        <th class="text-center" style="width: 120px;">상담 구분</th>
                        <th class="text-center" style="width: 120px;">상담자</th>
                        <th class="text-center" style="width: 120px;">상담 내용</th>
                      </tr>
                    </thead>
                    <tbody class="list"></tbody>
                  </table>
                </div> 
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card" style="height: 300px;">
          <div class="card-body">
            <form class="needs-validation" id="frm_counsel_mst" name="frm_counsel_mst" onsubmit="return false;" method="post" novalidate=""> 
              <input id="counsel_no"  type="hidden" name="counsel_no" /> 
              <div class="d-flex justify-content-between align-items-center mt-0 mb-2 fw-bold fs-8 border-bottom pb-1 text-primary">
                <span>대출 상담 관리 상세</span>
                <p class="text-end pb-1 mb-1 pd-1">
                  <button type="button" class="btn btn-info btn-sm" id="btn_counsel_clear"><i class="fa fa-check"></i>신규</button>
                  <button type="button" class="btn btn-primary btn-sm" id="btn_counsel_update" style="display: none"><i class="fa fa-paste"></i>수정</button>
                  <button type="button" class="btn btn-primary btn-sm" id="btn_counsel_delete" style="display: none"><i class="fa fa-paste"></i>삭제</button>
                  <button type="button" class="btn btn-primary btn-sm" id="btn_counsel_create"><i class="fa fa-paste"></i>저장</button>
                </p>
              </div>
              <div class="row mb-1"> 
                <div class="col-sm-4">
                  <div class="input-group input-group-sm mb-1">
                    <label class="col-sm-4 col-form-label col-form-label-sm" for="counsel_cd">상담유형</label>
                    <select class="form-select form-control-sm me-1" id="counsel_cd" name="counsel_cd" style="width: 120px" required>
                      <option value="">전체</option> 
                    </select>
                  </div> 
                </div>
                <div class="col-sm-4">
                  <div class="input-group input-group-sm mb-1">
                    <label class="col-sm-4 col-form-label col-form-label-sm" for="counsel_dt">상담일</label>
                    <div class="col-sm-8">
                      <input class="form-control form-control-sm" id="counsel_dt" type="text" name="counsel_dt" istyle="date" required />
                    </div>
                  </div>
                </div>
                <div class="col-sm-4"> 
                  <div class="input-group input-group-sm mb-1">
                    <label class="col-sm-4 col-form-label col-form-label-sm" for="counsel_cust_nm">상담대상</label> 
                    <div class="col-sm-8">
                      <input class="form-control form-control-sm " id="counsel_cust_nm" type="text" name="counsel_cust_nm"  maxlength="20" required />
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mb-1">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-1 col-form-label col-form-label-sm" for="counsel_conts">상담내용</label> 
                  <textarea class="form-control form-control-sm" id="counsel_conts" name="counsel_conts" rows="7" maxlength="500" required></textarea>
                </div>
              </div>
            </form> 
          </div>
        </div>
      </div>
    </div>
  </div> 

  <div class="modal fade" id="modal_schedule" tabindex="-1" >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div class="col-auto align-self-center">
            <h5 class="mb-0">대출 상환 스케줄</h5>
          </div>
          <div class="col-xl-9 text-end">
            <button type="button" class="btn btn-primary" id="btn_schedule_excel" aria-label="Excel">Excel</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          </div>          
        </div>
        <div class="modal-body" style="height: 440px;">
          <div class="table-responsive scrollbar" style="overflow-x: auto; min-width: 1050px;">
            <table class="table table-striped table-sm fs-9 mb-0 selectable-table table-hover selectable table-bordered" id="tbl_modal_schedule" style="border-collapse: collapse;">
              <thead class="bg-200">
                <tr>
                  <th class="text-center" style="width: 70px;">회차</th>
                  <th class="text-center" style="width: 100px;">상환예정일</th>
                  <th class="text-center" style="width: 110px;">거래전잔액</th>
                  <th class="text-center" style="width: 100px;">청구원금</th>
                  <th class="text-center" style="width: 90px;">청구이자</th>
                  <th class="text-center" style="width: 100px;">청구금액</th> 
                  <th class="text-center" style="width: 100px;">미수원금</th>
                  <th class="text-center" style="width: 100px;">미수이자</th>
                  <th class="text-center" style="width: 100px;">미수금액</th> 
                  <th class="text-center" style="width: 90px;">수납완료일</th>
                  <th class="text-center" style="width: 90px;">비고</th> 
                </tr>
              </thead>
              <tbody class="list"></tbody> 
              <tfoot>
                <tr>
                  <th colspan="2" class="text-center">총계</th>
                  <th class="text-right px-2"></th> 
                  <th class="text-right px-2"></th> 
                  <th class="text-right px-2"></th>
                  <th class="text-right px-2"></th> 
                  <th class="text-right px-2"></th>
                  <th class="text-right px-2"></th> 
                  <th class="text-right px-2"></th> 
                  <th class="text-right px-2"></th>  
                </tr>
              </tfoot>
            </table>
          </div>           
        </div>
        <div class="modal-footer">
          <div class="card" style="height: 230px;">
            <div class="card-body">
              <div class="table-responsive scrollbar" style="overflow-x: auto; min-width: 1050px;">
                <table class="table table-striped table-sm fs-9 mb-0 selectable-table table-hover selectable table-bordered" id="tbl_modal_recv_log" style="border-collapse: collapse;">
                  <thead class="bg-200">
                    <tr>
                      <th class="text-center" style="width: 50px;">순번</th>
                      <th class="text-center" style="width: 100px;">수납일</th>
                      <th class="text-center" style="width: 120px;">수납유형</th>
                      <th class="text-center" style="width: 120px;">수납원금</th>
                      <th class="text-center" style="width: 120px;">수납이자</th>
                      <th class="text-center" style="width: 120px;">수납금액</th>                       
                      <th class="text-center" style="width: 200px;">비고</th> 
                    </tr>
                  </thead>
                  <tbody class="list"></tbody> 
                  <tfoot>
                    <tr>
                      <th colspan="3" class="text-center">총계</th>
                      <th class="text-right px-2"></th> 
                      <th class="text-right px-2"></th> 
                      <th class="text-right px-2"></th> 
                      <th class="text-right px-2"></th>  
                    </tr>
                  </tfoot>
                </table>
              </div> 
            </div>
          </div>  
        </div>        
      </div>
    </div>
  </div>

  <div class="modal fade" id="modal_prepay" tabindex="-1" aria-labelledby="subtractmanage" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <form class="needs-validation" novalidate="" id="frm_prepay" name="frm_prepay" onsubmit="return false;">           
          <div class="modal-header">
            <h5 class="modal-title">중도 상환</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="prepay_loan_no">대출관리번호</label>
                  <input class="form-control form-control-sm bg-light" id="prepay_loan_no" type="text" name="prepay_loan_no" readonly/>
                </div>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="prepay_recv_date">중도상환일</label>
                  <input class="form-control form-control-sm bg-light" id="prepay_recv_date" type="text" name="prepay_recv_date" readonly/>
                </div>
              </div>
            </div>                         
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="pre_princ_amt">미수 원금</label>
                  <input class="form-control form-control-sm text-end bg-light" id="pre_princ_amt" type="text" name="pre_princ_amt" readonly/>
                </div>
              </div>
            </div>              
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="pre_int_amt">미수이자</label>
                  <input class="form-control form-control-sm text-end bg-light" id="pre_int_amt" type="text" name="pre_int_amt" readonly/>
                </div>
              </div>
            </div>              
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="post_princ_amt">잔여 원금</label>
                  <input class="form-control form-control-sm text-end bg-light" id="post_princ_amt" type="text" name="post_princ_amt" readonly/>
                </div>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="delay_int_amt">연체 이자</label>
                  <input class="form-control form-control-sm text-end bg-light" id="delay_int_amt" type="text" name="delay_int_amt" readonly/>
                </div>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="prepay_tot_amt">총수납금액 : </label>
                  <input class="form-control form-control-sm text-end bg-light" id="prepay_tot_amt" type="text" name="prepay_tot_amt" readonly/>
                  <!-- <h3 id="tot_prepay_amt" class="text-end">2,000,000</h3> -->
                </div>
              </div>                  
            </div>               
            <div class="row mb-1">
              <div class="col-sm-12">
                <div class="input-group input-group-sm mb-1">
                  <label class="col-sm-5 col-form-label col-form-label-sm" for="prepay_memo">메모</label>
                  <textarea class="form-control form-control-sm" id="prepay_memo" name="prepay_memo" rows="3" maxlength="50"></textarea>                  
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btn_prepay" aria-label="처리">중도 상환</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="모달 닫기">닫기</button>
          </div>          
        </form>
      </div>
    </div>
  </div> 

  <!-- 가맹점 선택 모달 -->
  <div class="modal fade" id="modal_chain_select" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">가맹점 선택</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive scrollbar">
            <table class="table table-striped table-sm fs-9 mb-0 table-hover" id="tbl_chain_select">
              <thead>
                <tr>
                  <th class="text-center">코드</th>
                  <th class="text-center">가맹점명</th>
                </tr>
              </thead>
              <tbody class="list"></tbody>
            </table>
          </div>
          <div class="text-muted mt-2">원하는 항목을 클릭하여 선택하세요.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" aria-label="모달 닫기">닫기</button>
        </div>
      </div>
    </div>
  </div>
</html>
